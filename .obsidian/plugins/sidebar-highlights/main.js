/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var st=Object.defineProperty;var at=Object.getOwnPropertyDescriptor;var ct=Object.getOwnPropertyNames;var ht=Object.prototype.hasOwnProperty;var gt=(I,r)=>{for(var t in r)st(I,t,{get:r[t],enumerable:!0})},dt=(I,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of ct(r))!ht.call(I,i)&&i!==t&&st(I,i,{get:()=>r[i],enumerable:!(e=at(r,i))||e.enumerable});return I};var ut=I=>dt(st({},"__esModule",{value:!0}),I);var mt={};gt(mt,{CollectionsManager:()=>Q,default:()=>X});module.exports=ut(mt);var E=require("obsidian");var v=require("obsidian");var A=require("obsidian"),z=class extends A.Modal{constructor(t,e){super(t);this.onSubmit=e}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Create a new collection"}),new A.Setting(t).setName("Collection name").setDesc("The name of your collection (Required)").addText(n=>{this.nameInput=n.inputEl,n.setPlaceholder("Important Highlights").onChange(a=>{let l=t.querySelector(".mod-cta");l&&(l.disabled=!a.trim())}),window.setTimeout(()=>n.inputEl.focus(),100)}),new A.Setting(t).setName("Collection description").setDesc("Provide more context about the collection (Optional)").addText(n=>{this.descriptionInput=n.inputEl,n.setPlaceholder("Research, etc.")});let e=t.createDiv({cls:"modal-button-container"});e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let s=e.createEl("button",{text:"Create collection",cls:"mod-cta"});s.disabled=!0,s.addEventListener("click",()=>this.handleSubmit()),t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.ctrlKey||n.metaKey)?this.handleSubmit():n.key==="Escape"&&this.close()})}handleSubmit(){let t=this.nameInput.value.trim(),e=this.descriptionInput.value.trim();if(!t){new A.Notice("Collection name is required"),this.nameInput.focus();return}this.onSubmit(t,e),this.close()}onClose(){let{contentEl:t}=this;t.empty()}},W=class extends A.Modal{constructor(t,e,i){super(t);this.collection=e,this.onSubmit=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Edit collection"}),new A.Setting(t).setName("Collection name").setDesc("The name of your collection (Required)").addText(n=>{this.nameInput=n.inputEl,n.setPlaceholder("Important Highlights").setValue(this.collection.name).onChange(a=>{let l=t.querySelector(".mod-cta");l&&(l.disabled=!a.trim())}),window.setTimeout(()=>{n.inputEl.focus(),n.inputEl.select()},100)}),new A.Setting(t).setName("Collection description").setDesc("Provide more context about the collection (Optional)").addText(n=>{this.descriptionInput=n.inputEl,n.setPlaceholder("Research, etc.").setValue(this.collection.description||"")});let e=t.createDiv({cls:"modal-button-container"});e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),e.createEl("button",{text:"Save changes",cls:"mod-cta"}).addEventListener("click",()=>this.handleSubmit()),t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.ctrlKey||n.metaKey)?this.handleSubmit():n.key==="Escape"&&this.close()})}handleSubmit(){let t=this.nameInput.value.trim(),e=this.descriptionInput.value.trim();if(!t){new A.Notice("Collection name is required"),this.nameInput.focus();return}this.onSubmit(t,e),this.close()}onClose(){let{contentEl:t}=this;t.empty()}};var V=require("obsidian"),_=class{constructor(){this.activeDropdown=null;this.documentClickHandlers=[];this.keydownHandlers=[];this.isOpen=!1;this.checkboxElements=new Map;this.activeItems=[]}isDropdownOpen(){return this.isOpen}closeActiveDropdown(){this.activeDropdown&&this.activeDropdown.parentNode&&(this.activeDropdown.classList.remove("dropdown-constrained-height"),this.activeDropdown.style.removeProperty("--dropdown-max-height"),this.activeDropdown.style.removeProperty("--dropdown-top"),this.activeDropdown.style.removeProperty("--dropdown-left"),this.activeDropdown.parentNode.removeChild(this.activeDropdown)),this.activeDropdown=null,this.isOpen=!1,this.checkboxElements.clear(),this.activeItems=[],this.documentClickHandlers.forEach(r=>{document.removeEventListener("click",r)}),this.documentClickHandlers=[],this.keydownHandlers.forEach(r=>{document.removeEventListener("keydown",r)}),this.keydownHandlers=[]}showDropdown(r,t,e={position:"below"}){if(this.isOpen){this.closeActiveDropdown();return}let i=r.getBoundingClientRect(),s=document.createElement("div");s.className=`menu highlights-dropdown-menu ${e.className||""}`,s.classList.add("dropdown-positioned"),this.activeDropdown=s,this.isOpen=!0,this.activeItems=[...t];let n=t.filter(T=>!T.separator),a=t.findIndex(T=>!T.separator),l=t.length-1-[...t].reverse().findIndex(T=>!T.separator);t.forEach((T,m)=>{let w=document.createElement("div");if(T.separator){w.className="menu-separator",s.appendChild(w);return}if(w.className=`menu-item ${T.className||"highlights-dropdown-item"}`,m===a&&w.classList.add("first-menu-item"),m===l&&w.classList.add("last-menu-item"),n.length===1&&m===a&&w.classList.add("only-menu-item"),T.checked!==void 0){let b=document.createElement("div");b.className="highlights-dropdown-check",T.checked?((0,V.setIcon)(b,"check"),w.classList.add("is-checked")):T.uncheckedIcon&&(0,V.setIcon)(b,T.uncheckedIcon),w.appendChild(b);let y=T.id||`item-${m}`;this.checkboxElements.set(y,{element:w,checkDiv:b})}else if(T.icon){let b=document.createElement("div");b.className="menu-item-icon",(0,V.setIcon)(b,T.icon),w.appendChild(b)}let S=document.createElement("span");S.textContent=T.text,w.appendChild(S),w.addEventListener("click",b=>{if(b.preventDefault(),b.stopPropagation(),T.onClick&&T.onClick(),T.checked!==void 0){let y=T.id||`item-${m}`,k=!T.checked;this.activeItems[m].checked=k,this.updateCheckboxState(y,k),this.checkShouldAutoClose()}}),s.appendChild(w)}),document.body.appendChild(s);let o=s.getBoundingClientRect(),c=o.height,h=o.width,g=window.innerHeight,d=window.innerWidth,f=g-i.bottom,u=i.top,p,x;f>=c+8?(p=i.bottom+4,s.classList.add("dropdown-positioned-below")):u>=c+8?(p=i.top-c-4,s.classList.add("dropdown-positioned-above")):f>u?(p=i.bottom+4,s.classList.add("dropdown-positioned-below-constrained"),s.style.setProperty("--dropdown-max-height",`${f-8}px`),s.classList.add("dropdown-constrained-height")):(p=8,s.classList.add("dropdown-positioned-above-constrained"),s.style.setProperty("--dropdown-max-height",`${i.top-12}px`),s.classList.add("dropdown-constrained-height")),x=i.left,i.left+h>d-8&&(x=Math.max(8,i.right-h)),s.classList.add("dropdown-left-aligned"),s.style.setProperty("--dropdown-top",`${p}px`),s.style.setProperty("--dropdown-left",`${x}px`);let C=T=>{!s.contains(T.target)&&!r.contains(T.target)&&this.closeActiveDropdown()};this.documentClickHandlers.push(C),window.setTimeout(()=>{document.addEventListener("click",C)},100);let H=T=>{T.key==="Escape"&&this.closeActiveDropdown()};this.keydownHandlers.push(H),document.addEventListener("keydown",H)}updateCheckboxState(r,t){let e=this.checkboxElements.get(r);if(!e)return;let{element:i,checkDiv:s}=e,n=this.activeItems.find(a=>(a.id||`item-${this.activeItems.indexOf(a)}`)===r);t?((0,V.setIcon)(s,"check"),i.classList.add("is-checked")):(s.empty(),i.classList.remove("is-checked"),n&&n.uncheckedIcon&&(0,V.setIcon)(s,n.uncheckedIcon))}checkShouldAutoClose(){this.activeItems.some(t=>t.checked!==void 0&&t.checked===!0)||window.setTimeout(()=>{this.closeActiveDropdown()},100)}updateAllCheckboxStates(r){this.activeItems.forEach((t,e)=>{if(t.checked!==void 0){let i=t.id||`item-${e}`;r.hasOwnProperty(i)&&(t.checked=r[i],this.updateCheckboxState(i,r[i]))}}),this.checkShouldAutoClose()}cleanup(){this.closeActiveDropdown()}};var D=require("obsidian"),q=class{constructor(r){this.plugin=r}createFileContextMenu(r){let t=new D.Menu;return t.addItem(e=>{e.setTitle("Open in new tab").setIcon("lucide-plus").onClick(()=>{this.plugin.app.workspace.openLinkText(r.path,"","tab")})}),t.addItem(e=>{e.setTitle("Open to the right").setIcon("lucide-separator-vertical").onClick(()=>{this.plugin.app.workspace.openLinkText(r.path,"","split")})}),t.addSeparator(),t}createHighlightItem(r,t,e={}){let i=r.createDiv({cls:`highlight-item-card${this.plugin.selectedHighlightId===t.id?" selected":""}`,attr:{"data-highlight-id":t.id}});return this.applyHighlightStyling(i,t),this.createHoverColorPicker(i,t,e),this.createQuoteSection(i,t,e),this.createActionsSection(i,t,e),this.createCommentsSection(i,t,e),i}applyHighlightStyling(r,t){if(t.isNativeComment)r.classList.add("highlight-native-comment");else{let e=t.color||this.plugin.settings.highlightColor,i=this.getColorClassName(e);r.classList.add(i),i==="highlight-color-default"&&(r.classList.remove("highlight-color-default"),r.classList.add("highlight-color-custom"),r.style.setProperty("--highlight-color",e))}this.plugin.selectedHighlightId===t.id&&r.classList.add("highlight-selected")}getColorClassName(r){return{[this.plugin.settings.customColors.yellow]:"highlight-color-yellow",[this.plugin.settings.customColors.red]:"highlight-color-red",[this.plugin.settings.customColors.teal]:"highlight-color-teal",[this.plugin.settings.customColors.blue]:"highlight-color-blue",[this.plugin.settings.customColors.green]:"highlight-color-green"}[r]||"highlight-color-default"}createQuoteSection(r,t,e){let i=r.createDiv({cls:"highlight-quote"});this.renderMarkdownToElement(i,t.text),e.searchTerm&&e.searchTerm.length>0&&this.highlightSearchMatches(i,e.searchTerm),this.addTagsToQuote(i,t,e),i.addEventListener("click",s=>{var n;(n=e.onHighlightClick)==null||n.call(e,t,s)}),i.addEventListener("mouseover",s=>{this.plugin.app.workspace.trigger("hover-link",{event:s,source:"sidebar-highlights",hoverParent:i,targetEl:i,linktext:t.filePath,state:{scroll:t.startOffset}})})}addTagsToQuote(r,t,e){let i=this.extractTagsFromHighlight(t);if(i.length>0){let s=r.createDiv({cls:"highlight-tags"});i.forEach(n=>{s.createEl("span",{cls:"highlight-tag",text:n}).addEventListener("click",l=>{var o;l.stopPropagation(),(o=e.onTagClick)==null||o.call(e,n)})})}}createActionsSection(r,t,e){if(e.showHighlightActions===!1)return;let i=r.createDiv({cls:"highlight-actions"});this.addFileNameInfo(i,t,e);let s=i.createDiv({cls:"highlight-info-container"});this.addStatsInfo(s,t,e),this.addActionButtons(i,t,e)}addFileNameInfo(r,t,e){var i;if(e.showFilename){let s=((i=t.filePath.split("/").pop())==null?void 0:i.replace(/\.md$/,""))||t.filePath,n=r.createEl("small",{cls:"highlight-filename",text:s,attr:{title:t.filePath}});n.addEventListener("click",a=>{var l;a.stopPropagation(),(l=e.onFileNameClick)==null||l.call(e,t.filePath,a)}),n.addEventListener("contextmenu",a=>{a.preventDefault(),a.stopPropagation();let l=this.plugin.app.vault.getAbstractFileByPath(t.filePath);if(l instanceof D.TFile){let o=this.createFileContextMenu(l);this.plugin.app.workspace.trigger("file-menu",o,l,"sidebar-highlights"),o.showAtMouseEvent(a)}}),n.addEventListener("mouseover",a=>{this.plugin.app.workspace.trigger("hover-link",{event:a,source:"sidebar-highlights",hoverParent:n,targetEl:n,linktext:t.filePath})})}}addStatsInfo(r,t,e){var g;let i=t.line>=0?t.line+1:"Unknown",s=r.createDiv({cls:"highlight-info-line"}),n=s.createDiv({cls:"highlight-stats-section"});this.createInfoItem(n,"text",`${i}`,"highlight-line-info");let a=t.isNativeComment?0:((g=t.footnoteContents)==null?void 0:g.filter(d=>d.trim()!=="").length)||0,l=t.isNativeComment?"highlight-line-info highlight-comment-stat disabled":"highlight-line-info highlight-comment-stat clickable",o=this.createInfoItem(n,"message-square",`${a}`,l);t.isNativeComment||o.addEventListener("click",d=>{var f;d.stopPropagation(),(f=e.onCommentToggle)==null||f.call(e,t.id)});let c=this.plugin.collectionsManager.getHighlightCollectionCount(t.id);this.createInfoItem(n,"folder-open",`${c}`,"highlight-line-info highlight-collection-stat clickable").addEventListener("click",d=>{var f;d.stopPropagation(),(f=e.onCollectionsMenu)==null||f.call(e,d,t)}),this.addTimestampToInfoLine(s,t,e)}createInfoItem(r,t,e,i){let s=r.createDiv({cls:i}),n=s.createDiv({cls:t==="message-square"?"comment-icon":"line-icon"});return(0,D.setIcon)(n,t),s.createSpan({text:e}),s}addTimestampToInfoLine(r,t,e){if(e.showTimestamp&&t.createdAt){let i=(0,D.moment)(t.createdAt),s=e.dateFormat?i.format(e.dateFormat):i.format("YYYY-MM-DD HH:mm"),a=r.createDiv({cls:"highlight-timestamp-container"}).createDiv({cls:"highlight-timestamp-info",text:s,attr:{title:`Created: ${s}`}})}}addActionButtons(r,t,e){let i=r.createDiv({cls:"comment-buttons"})}createCommentsSection(r,t,e){var s;if(!e.isCommentsVisible)return;let i=r.createDiv({cls:"highlight-comments"});if(!t.isNativeComment){let n=((s=t.footnoteContents)==null?void 0:s.filter(a=>a.trim()!==""))||[];n.length>0&&n.forEach((a,l)=>{let o=i.createDiv({cls:"highlight-comment"});this.renderMarkdownToElement(o,a),o.addEventListener("click",c=>{var h;c.stopPropagation(),(h=e.onCommentClick)==null||h.call(e,t,l,c)})})}this.createAddCommentLine(i,t,e)}createAddCommentLine(r,t,e){let i=r.createDiv({cls:"highlight-add-comment-line"}),s=i.createDiv({cls:"highlight-add-comment-icon"});(0,D.setIcon)(s,"plus"),i.createSpan({text:"Add comment"}),i.addEventListener("click",n=>{var a;n.stopPropagation(),(a=e.onAddComment)==null||a.call(e,t)})}highlightSearchMatches(r,t){if(!t)return;let e=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(e,"gi"),s=document.createTreeWalker(r,NodeFilter.SHOW_TEXT,null),n,a=[];for(;n=s.nextNode();)n.nodeValue&&n.nodeValue.trim()!==""&&!(n.parentElement&&n.parentElement.classList.contains("search-term-highlight"))&&a.push(n);a.forEach(l=>{let o=l.nodeValue,c=[],h=0,g;for(;(g=i.exec(o))!==null;){g.index>h&&c.push(document.createTextNode(o.substring(h,g.index)));let d=document.createElement("span");d.className="search-term-highlight",d.textContent=g[0],c.push(d),h=i.lastIndex}h<o.length&&c.push(document.createTextNode(o.substring(h))),c.length>0&&l.parentNode&&(c.forEach(d=>l.parentNode.insertBefore(d,l)),l.parentNode.removeChild(l))})}renderMarkdownToElement(r,t){r.empty();let e=this.parseMarkdownSegments(t);for(let i of e)if(i.type==="text")r.appendText(i.content||"");else if(i.type==="strong"){let s=r.createEl("strong");s.textContent=i.content||""}else if(i.type==="em"){let s=r.createEl("em");s.textContent=i.content||""}else if(i.type==="code"){let s=r.createEl("code");s.textContent=i.content||""}else if(i.type==="del"){let s=r.createEl("del");s.textContent=i.content||""}else if(i.type==="link"){let s=r.createEl("a");s.textContent=i.text||"",s.href=i.url||"",s.target="_blank"}}parseMarkdownSegments(r){let t=[],e=[{regex:/\*\*(.*?)\*\*/g,type:"strong"},{regex:/__(.*?)__/g,type:"strong"},{regex:/~~(.*?)~~/g,type:"del"},{regex:/`([^`]+?)`/g,type:"code"},{regex:/\[([^\]]+)\]\(([^)]+)\)/g,type:"link"}],i=[];for(let a of e){let l;for(a.regex.lastIndex=0;(l=a.regex.exec(r))!==null;)a.type==="link"?i.push({start:l.index,end:l.index+l[0].length,type:a.type,text:l[1],url:l[2]}):i.push({start:l.index,end:l.index+l[0].length,type:a.type,content:l[1]})}this.findItalicMatches(r,i),i.sort((a,l)=>a.start-l.start);let s=[];for(let a of i)s.some(l=>a.start>=l.start&&a.start<l.end||a.end>l.start&&a.end<=l.end)||s.push(a);let n=0;for(let a of s)n<a.start&&t.push({type:"text",content:r.substring(n,a.start)}),t.push(a),n=a.end;return n<r.length&&t.push({type:"text",content:r.substring(n)}),t}findItalicMatches(r,t){for(let e=0;e<r.length;e++)if(r[e]==="*"&&(e===0||r[e-1]!=="*")&&(e===r.length-1||r[e+1]!=="*")){for(let i=e+1;i<r.length;i++)if(r[i]==="*"&&(i===r.length-1||r[i+1]!=="*")&&(i===0||r[i-1]!=="*")){let s=r.substring(e+1,i);if(s.length>0&&s.indexOf("*")===-1){t.push({start:e,end:i+1,type:"em",content:s}),e=i;break}}}for(let e=0;e<r.length;e++)if(r[e]==="_"&&(e===0||r[e-1]!=="_")&&(e===r.length-1||r[e+1]!=="_")){for(let i=e+1;i<r.length;i++)if(r[i]==="_"&&(i===r.length-1||r[i+1]!=="_")&&(i===0||r[i-1]!=="_")){let s=r.substring(e+1,i);if(s.length>0&&s.indexOf("_")===-1){t.push({start:e,end:i+1,type:"em",content:s}),e=i;break}}}}extractTagsFromHighlight(r){let t=[];if(r.footnoteContents){for(let e of r.footnoteContents)if(e.trim()!==""){let i=e.match(/#[\p{L}\p{N}\p{M}_/-]+/gu);i&&i.forEach(s=>{let n=s.substring(1);t.includes(n)||t.push(n)})}}return t}isColorChangeable(r){return!r.isNativeComment&&!this.isHtmlHighlight(r)}isHtmlHighlight(r){return r.type==="html"}createHoverColorPicker(r,t,e){if(!this.isColorChangeable(t))return;let i=r.createDiv({cls:"highlight-border-hover-zone"}),s=r.createDiv({cls:"hover-color-picker"}),n=s.createDiv({cls:"hover-color-options"});[this.plugin.settings.customColors.yellow,this.plugin.settings.customColors.red,this.plugin.settings.customColors.teal,this.plugin.settings.customColors.blue,this.plugin.settings.customColors.green].forEach((h,g)=>{n.createDiv({cls:"hover-color-option",attr:{"data-color":h,style:`--option-index: ${g}`}}).addEventListener("click",f=>{var u;f.stopPropagation(),(u=e.onColorChange)==null||u.call(e,t,h)})});let l,o=()=>{l=window.setTimeout(()=>{s.classList.add("visible")},500)},c=()=>{window.clearTimeout(l),s.classList.remove("visible")};i.addEventListener("mouseenter",o),i.addEventListener("mouseleave",c),s.addEventListener("mouseenter",()=>{window.clearTimeout(l),s.classList.add("visible")}),s.addEventListener("mouseleave",c)}};var B=class{isHtmlHighlight(r){return!r.isNativeComment&&!!r.color}getHtmlHighlightPatterns(r){let t=this.escapeRegex(r.text),e=[];return e.push({pattern:`<span\\s+style=["'][^"']*background:\\s*[^;"']+[^"']*["'][^>]*>${t}<\\/span>`}),e.push({pattern:`<font\\s+color=["'][^"']+["'][^>]*>${t}<\\/font>`}),e.push({pattern:`<mark[^>]*>${t}<\\/mark>`}),e}extractInlineFootnotes(r,t){let e=[],i=r.substring(t),s=/(\s*\^\[([^\]]+)\])/g,n;for(;(n=s.exec(i))!==null&&(n.index===0||this.isValidFootnotePosition(i,n.index));)e.push({content:n[2],startIndex:t+n.index,endIndex:t+n.index+n[0].length});return e}isValidFootnotePosition(r,t){let e=r.substring(0,t);return/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/.test(e)}insertInlineFootnote(r,t,e){let i=r.getValue(),s=this.escapeRegex(t.text),n=null,a=1/0;if(t.isNativeComment){let f=`%%${s}%%`,u=new RegExp(f,"g"),p;for(;(p=u.exec(i))!==null;){let x=Math.abs(p.index-t.startOffset);x<a&&(a=x,n={index:p.index,length:p[0].length})}}else if(this.isHtmlHighlight(t)){let f=this.getHtmlHighlightPatterns(t);for(let{pattern:u}of f){let p=new RegExp(u,"gi"),x;for(;(x=p.exec(i))!==null;){let C=Math.abs(x.index-t.startOffset);C<a&&(a=C,n={index:x.index,length:x[0].length})}}}else{let f=`==${s}==`,u=new RegExp(f,"g"),p;for(;(p=u.exec(i))!==null;){let x=Math.abs(p.index-t.startOffset);x<a&&(a=x,n={index:p.index,length:p[0].length})}}if(!n)return!1;let l=n.index+n.length,o=i.substring(l),c=o.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),h=c?c[0].length:0;if(h>0&&o.length>h){let f=o.substring(h);if(!f.match(/^\S/)){let u=f.match(/^(\s+)/);if(u){let p=u[1];f.substring(u[0].length).length===0&&(h+=u[0].length)}}}else if(h>0){let f=o.substring(h).match(/^\s+/);f&&(h+=f[0].length)}l+=h;let g=`^[${e}]`,d=r.offsetToPos(l);if(r.replaceRange(g,d),e.length>0){let f=r.offsetToPos(l+g.indexOf(e)),u=r.offsetToPos(l+g.indexOf(e)+e.length);r.setSelection(f,u)}else{let f=r.offsetToPos(l+g.length-1);r.setCursor(f)}return r.focus(),!0}escapeRegex(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var P=class{static parseQuery(r){if(!r.trim())return{ast:null};try{return this.tokens=this.tokenize(r),this.position=0,this.depth=0,{ast:this.parseExpression()}}catch(t){return console.warn("Search parsing error:",t),{ast:null}}}static tokenize(r){let t=[],e=0,i=0,s=r.length*2;for(;e<r.length&&i<s;){if(i++,/\s/.test(r[e])){e++;continue}if(r[e]==="("){t.push({type:"LPAREN",value:"("}),e++;continue}if(r[e]===")"){t.push({type:"RPAREN",value:")"}),e++;continue}if(r.substr(e,3)==="AND"&&(e+3>=r.length||/\s/.test(r[e+3]))){t.push({type:"AND",value:"AND"}),e+=3;continue}if(r.substr(e,2)==="OR"&&(e+2>=r.length||/\s/.test(r[e+2]))){t.push({type:"OR",value:"OR"}),e+=2;continue}if(r[e]==='"'){e++;let o=e;for(;e<r.length&&r[e]!=='"';)e++;if(e<r.length){let c=r.substring(o,e);c.trim()&&t.push({type:"TEXT",value:c}),e++}else{let c=r.substring(o-1);t.push({type:"TEXT",value:c}),e=r.length}continue}let n=r.substr(e).match(/^(-?)([#@])([a-zA-Z0-9_/-]+)/);if(n){let o=n[1]==="-",c=n[2],h=n[3];t.push({type:"FILTER",value:h,filterType:c==="#"?"tag":"collection",exclude:o}),e+=n[0].length;continue}let a=e,l="";for(;e<r.length&&!(r.substr(e,3)==="AND"&&(e+3>=r.length||/\s/.test(r[e+3]))||r.substr(e,2)==="OR"&&(e+2>=r.length||/\s/.test(r[e+2]))||r[e]==="("||r[e]===")"||r[e]==='"'||r.substr(e).match(/^(-?)([#@])([a-zA-Z0-9_-]+)/));)l+=r[e],e++;l=l.trim(),l?t.push({type:"TEXT",value:l}):e===a&&e++}return t}static parseExpression(){var e;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let r=this.parseAndExpression(),t=0;for(;((e=this.current())==null?void 0:e.type)==="OR"&&t<100;){this.advance();let i=this.parseAndExpression();if(!i)break;r={type:"operator",operator:"OR",left:r,right:i},t++}return this.depth--,r}static parseAndExpression(){var e,i;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let r=this.parsePrimary(),t=0;for(;(((e=this.current())==null?void 0:e.type)==="AND"||this.isImplicitAnd())&&t<100;){((i=this.current())==null?void 0:i.type)==="AND"&&this.advance();let s=this.parsePrimary();if(!s)break;r={type:"operator",operator:"AND",left:r,right:s},t++}return this.depth--,r}static parsePrimary(){var t;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let r=this.current();if(!r)return this.depth--,null;if(r.type==="LPAREN"){this.advance();let e=this.parseExpression();return((t=this.current())==null?void 0:t.type)==="RPAREN"&&this.advance(),this.depth--,e}if(r.type==="FILTER"){this.advance();let e={type:"filter",filterType:r.filterType,value:r.value,exclude:r.exclude||!1};return this.depth--,e}if(r.type==="TEXT"){this.advance();let e={type:"text",value:r.value};return this.depth--,e}return this.depth--,null}static current(){return this.tokens[this.position]}static advance(){this.position++}static isImplicitAnd(){let r=this.current();return!!r&&(r.type==="FILTER"||r.type==="TEXT"||r.type==="LPAREN")}static getTokensFromQuery(r){let t=[],e=this.parseQuery(r);return e.ast&&this.extractTokensFromAST(e.ast,t),t}static extractTokensFromAST(r,t){if(r.type==="filter"){let e=r;t.push({type:e.filterType,value:e.value,exclude:e.exclude})}else if(r.type==="text"){let e=r;t.push({type:"text",value:e.value,exclude:!1})}else if(r.type==="operator"){let e=r;this.extractTokensFromAST(e.left,t),this.extractTokensFromAST(e.right,t)}}};P.tokens=[],P.position=0,P.depth=0,P.MAX_DEPTH=50;var U=class{constructor(r,t,e,i){this.currentSuggestions=[];this.selectedIndex=-1;this.input=r,this.container=t,this.onSearchChange=e,this.suggestions=i,this.createDropdown(),this.createPreview(),this.setupEventListeners()}createDropdown(){this.dropdown=this.container.createDiv({cls:"simple-search-dropdown"}),this.dropdown.classList.add("hidden")}createPreview(){this.previewElement=this.container.createDiv({cls:"simple-search-preview"}),this.previewElement.classList.add("hidden")}setupEventListeners(){this.input.addEventListener("input",()=>{this.handleInput()}),this.input.addEventListener("keydown",r=>{this.handleKeydown(r)}),this.input.addEventListener("focus",()=>{this.updateAutocomplete()}),this.input.addEventListener("blur",()=>{window.setTimeout(()=>this.hideDropdown(),150)})}handleInput(){let r=this.input.value,t=P.parseQuery(r);this.updatePreview(t),this.updateAutocomplete(),this.onSearchChange(r,t)}handleKeydown(r){if(!this.dropdown.classList.contains("hidden"))switch(r.key){case"ArrowDown":r.preventDefault(),this.selectNext();break;case"ArrowUp":r.preventDefault(),this.selectPrevious();break;case"Enter":r.preventDefault(),this.applySuggestion();break;case"Escape":r.preventDefault(),this.hideDropdown();break}}updateAutocomplete(){let r=this.input.value,t=this.input.selectionStart||0,e=r.substring(0,t),i=e.match(/-?#([a-zA-Z0-9_/-]*)$/),s=e.match(/-?@([a-zA-Z0-9_-]*)$/);i?this.showSuggestions("tag",i[1],i[0].startsWith("-")):s?this.showSuggestions("collection",s[1],s[0].startsWith("-")):this.hideDropdown()}showSuggestions(r,t,e){let i=r==="tag"?this.suggestions.tags:this.suggestions.collections;if(this.currentSuggestions=i.filter(s=>s.toLowerCase().includes(t.toLowerCase())).slice(0,8),this.dropdown.empty(),this.selectedIndex=-1,this.currentSuggestions.length===0){this.hideDropdown();return}this.currentSuggestions.forEach((s,n)=>{let a=this.dropdown.createDiv({cls:"simple-search-suggestion"}),l=a.createSpan({cls:"simple-search-suggestion-icon",text:r==="tag"?"#":"@"});e&&l.classList.add("exclude");let o=this.formatNestedTag(s);a.createSpan({cls:"simple-search-suggestion-text",text:o}),a.addEventListener("click",()=>{this.selectedIndex=n,this.applySuggestion()}),a.addEventListener("mouseenter",()=>{this.setSelected(n)})}),this.dropdown.classList.remove("hidden")}selectNext(){this.currentSuggestions.length!==0&&this.setSelected((this.selectedIndex+1)%this.currentSuggestions.length)}selectPrevious(){this.currentSuggestions.length!==0&&this.setSelected(this.selectedIndex<=0?this.currentSuggestions.length-1:this.selectedIndex-1)}setSelected(r){let t=this.dropdown.querySelectorAll(".simple-search-suggestion");t.forEach(e=>e.classList.remove("selected")),r>=0&&r<t.length&&(t[r].classList.add("selected"),this.selectedIndex=r)}applySuggestion(){if(this.selectedIndex<0||this.selectedIndex>=this.currentSuggestions.length)return;let r=this.currentSuggestions[this.selectedIndex],t=this.input.value,e=this.input.selectionStart||0,i=t.substring(0,e),s=t.substring(e),n=i.match(/-?#([a-zA-Z0-9_-]*)$/),a=i.match(/-?@([a-zA-Z0-9_-]*)$/),l,o;if(n){let h=(n[0].startsWith("-")?"-#":"#")+r+" ";l=i.replace(/-?#[a-zA-Z0-9_/-]*$/,h)+s,o=i.replace(/-?#[a-zA-Z0-9_/-]*$/,h).length}else if(a){let h=(a[0].startsWith("-")?"-@":"@")+r+" ";l=i.replace(/-?@[a-zA-Z0-9_-]*$/,h)+s,o=i.replace(/-?@[a-zA-Z0-9_-]*$/,h).length}else return;this.input.value=l,this.input.setSelectionRange(o,o),this.hideDropdown(),this.handleInput()}hideDropdown(){this.dropdown.classList.add("hidden"),this.selectedIndex=-1}updatePreview(r){if(this.previewElement.empty(),!this.input.value.trim()){this.previewElement.classList.add("hidden");return}if(this.previewElement.classList.remove("hidden"),!r.ast){this.previewElement.createSpan({cls:"simple-search-preview-text",text:"Use #tag @collection (-# to exclude)"});return}let t=r.ast?this.generateDescription(r.ast):"Invalid search query";this.previewElement.createSpan({cls:"simple-search-preview-label",text:"Matching: "}),this.previewElement.createSpan({cls:"simple-search-preview-logic",text:t})}generateDescription(r){return r?this.generateNodeDescription(r):"Invalid"}generateNodeDescription(r){if(r.type==="filter"){let t=r,e=t.exclude?"-":"",i=t.filterType==="tag"?"#":"@";return`${e}${i}${t.value}`}else{if(r.type==="text")return`"${r.value}"`;if(r.type==="operator"){let t=r,e=this.generateNodeDescription(t.left),i=this.generateNodeDescription(t.right);return`${e} ${t.operator} ${i}`}}return""}updateSuggestions(r){this.suggestions=r,this.updateAutocomplete()}clear(){this.input.value="",this.hideDropdown(),this.handleInput()}setValue(r){this.input.value=r,this.handleInput()}formatNestedTag(r){return r}};var pt="highlights-sidebar",Y=class extends v.ItemView{constructor(t,e){super(t);this.highlightCommentsVisible=new Map;this.groupingMode="none";this.commentsExpanded=!1;this.selectedTags=new Set;this.selectedCollections=new Set;this.viewMode="current";this.currentCollectionId=null;this.preservedScrollTop=0;this.isHighlightFocusing=!1;this.currentPage=0;this.itemsPerPage=100;this.totalHighlights=[];this.isPreservingPagination=!1;this.currentGroupPage=0;this.totalGroups=[];this.isColorChanging=!1;this.searchExpanded=!1;this.currentSearchTokens=[];this.currentParsedSearch={ast:null};this.dropdownManager=new _;this.savedScrollPosition=0;this.showNativeComments=!0;this.plugin=e,this.highlightRenderer=new q(e),this.groupingMode=e.settings.groupingMode||"none",this.showNativeComments=this.plugin.app.loadLocalStorage("sidebar-highlights-show-native-comments")!=="false"}getViewType(){return pt}getDisplayText(){return"Highlights"}getIcon(){return"highlighter"}async onOpen(){if(this.contentEl.empty(),this.contentEl.classList.add("highlights-sidebar-content"),this.plugin.settings.showToolbar){let n=this.contentEl.createDiv({cls:"highlights-search-container"}),a=n.createEl("button",{cls:"highlights-group-button"});this.searchButton=a,(0,v.setIcon)(a,"search"),(0,v.setTooltip)(a,"Search"),a.addEventListener("click",()=>{this.toggleSearch()});let l=n.createEl("button",{cls:"highlights-group-button"});(0,v.setIcon)(l,"group"),(0,v.setTooltip)(l,"Group highlights"),this.updateGroupButtonState(l),l.addEventListener("click",u=>{let p=new v.Menu;p.addItem(x=>{x.setTitle("None").setIcon("list").setChecked(this.groupingMode==="none").onClick(()=>{this.groupingMode="none",this.updateGroupButtonState(l),this.saveGroupingModeToSettings(),this.renderContent()})}),p.addSeparator(),p.addItem(x=>{x.setTitle("Color").setIcon("palette").setChecked(this.groupingMode==="color").onClick(()=>{this.groupingMode="color",this.updateGroupButtonState(l),this.saveGroupingModeToSettings(),this.renderContent()})}),p.addSeparator(),p.addItem(x=>{x.setTitle("Highlight comments \u2191").setIcon("sort-asc").setChecked(this.groupingMode==="comments-asc").onClick(()=>{this.groupingMode="comments-asc",this.updateGroupButtonState(l),this.saveGroupingModeToSettings(),this.renderContent()})}),p.addItem(x=>{x.setTitle("Highlight comments \u2193").setIcon("sort-desc").setChecked(this.groupingMode==="comments-desc").onClick(()=>{this.groupingMode="comments-desc",this.updateGroupButtonState(l),this.saveGroupingModeToSettings(),this.renderContent()})}),p.addSeparator(),p.addItem(x=>{x.setTitle("Date created \u2191").setIcon("calendar").setChecked(this.groupingMode==="date-created-asc").onClick(()=>{this.groupingMode="date-created-asc",this.updateGroupButtonState(l),this.saveGroupingModeToSettings(),this.renderContent()})}),p.addItem(x=>{x.setTitle("Date created \u2193").setIcon("calendar").setChecked(this.groupingMode==="date-created-desc").onClick(()=>{this.groupingMode="date-created-desc",this.updateGroupButtonState(l),this.saveGroupingModeToSettings(),this.renderContent()})}),p.addSeparator(),p.addItem(x=>{x.setTitle("Parent").setIcon("folder").setChecked(this.groupingMode==="parent").onClick(()=>{this.groupingMode="parent",this.updateGroupButtonState(l),this.saveGroupingModeToSettings(),this.renderContent()})}),p.addItem(x=>{x.setTitle("Collection").setIcon("folder-open").setChecked(this.groupingMode==="collection").onClick(()=>{this.groupingMode="collection",this.updateGroupButtonState(l),this.saveGroupingModeToSettings(),this.renderContent()})}),p.addItem(x=>{x.setTitle("Filename").setIcon("file-text").setChecked(this.groupingMode==="filename").onClick(()=>{this.groupingMode="filename",this.updateGroupButtonState(l),this.saveGroupingModeToSettings(),this.renderContent()})}),p.showAtMouseEvent(u)});let o=n.createEl("button",{cls:"highlights-group-button"});(0,v.setTooltip)(o,"Toggle native comments"),this.updateNativeCommentsToggleState(o),o.addEventListener("click",()=>{this.toggleNativeCommentsVisibility(),this.updateNativeCommentsToggleState(o),this.renderContent()});let c=n.createEl("button",{cls:"highlights-group-button"});(0,v.setTooltip)(c,"Toggle highlight comments"),this.commentsToggleButton=c,this.updateCommentsToggleIcon(c),c.addEventListener("click",()=>{this.toggleAllComments(),this.updateCommentsToggleIcon(c),this.renderContent()});let h=n.createEl("button",{cls:"highlights-group-button"});(0,v.setTooltip)(h,"Revert highlight colors"),(0,v.setIcon)(h,"rotate-ccw"),h.addEventListener("click",()=>{this.resetAllColors()});let g=n.createEl("button",{cls:"highlights-group-button highlights-tag-filter-button"});(0,v.setTooltip)(g,"Filter"),(0,v.setIcon)(g,"list-filter"),g.addEventListener("click",u=>{this.showTagFilterMenu(u)});let d=n.createEl("button",{cls:"highlights-group-button"});(0,v.setTooltip)(d,"Collection Navigation"),this.updateCollectionNavButton(d),d.addEventListener("click",()=>{this.viewMode==="collections"&&this.currentCollectionId?(this.currentCollectionId=null,this.renderContent()):this.showNewCollectionDialog()});let f=this.contentEl.createDiv({cls:"highlights-search-input-container hidden"});this.searchInputEl=f.createEl("input",{type:"text",placeholder:"Search highlights, use #tag @collection (-# to exclude)...",cls:"highlights-search-input"}),this.simpleSearchManager=new U(this.searchInputEl,f,(u,p)=>this.handleSearchInput(u,p),{tags:this.getAvailableTags(),collections:this.getAvailableCollections()})}let t=this.contentEl.createDiv({cls:"highlights-tabs-container"}),e=t.createEl("button",{cls:"highlights-tab active"});(0,v.setIcon)(e,"file-text"),(0,v.setTooltip)(e,"Current note");let i=t.createEl("button",{cls:"highlights-tab"});(0,v.setIcon)(i,"files"),(0,v.setTooltip)(i,"All notes");let s=t.createEl("button",{cls:"highlights-tab"});(0,v.setIcon)(s,"folder-open"),(0,v.setTooltip)(s,"Collections"),e.addEventListener("click",()=>{this.viewMode!=="current"&&(e.classList.add("active"),i.classList.remove("active"),s.classList.remove("active"),this.viewMode="current",this.selectedTags.clear(),this.selectedCollections.clear(),this.updateContent())}),i.addEventListener("click",()=>{this.viewMode!=="all"&&(i.classList.add("active"),e.classList.remove("active"),s.classList.remove("active"),this.viewMode="all",this.selectedTags.clear(),this.selectedCollections.clear(),this.updateContent())}),s.addEventListener("click",()=>{this.viewMode!=="collections"&&(s.classList.add("active"),e.classList.remove("active"),i.classList.remove("active"),this.viewMode="collections",this.currentCollectionId=null,this.selectedTags.clear(),this.selectedCollections.clear(),this.updateContent())}),this.contentAreaEl=this.contentEl.createDiv({cls:"highlights-list-area"}),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"}),this.renderContent()}async onClose(){this.dropdownManager.cleanup(),this.highlightCommentsVisible.clear(),this.selectedTags.clear()}navigateToCollection(t){if(!this.plugin.collectionsManager.getCollection(t)){new v.Notice("Collection not found");return}this.viewMode="collections",this.currentCollectionId=t;let i=this.contentEl.querySelectorAll(".highlights-tab");if(i.length>=3){let s=i[0],n=i[1],a=i[2];s.classList.remove("active"),n.classList.remove("active"),a.classList.remove("active"),a.classList.add("active")}this.selectedTags.clear(),this.renderContent()}refresh(){this.selectedTags.clear();let t=this.viewMode,e=this.currentCollectionId,i=this.isHighlightFocusing||this.isColorChanging,s=this.preservedScrollTop;i||this.captureScrollPosition(),this.onOpen(),this.viewMode=t,this.currentCollectionId=e,this.updateTabStates(),this.restoreSelectedHighlight(),i?requestAnimationFrame(()=>{this.contentAreaEl&&(this.contentAreaEl.scrollTop=s)}):this.restoreScrollPosition()}updateTabStates(){let t=this.contentEl.querySelectorAll(".highlights-tab");if(t.length>=3){let e=t[0],i=t[1],s=t[2];switch(e.classList.remove("active"),i.classList.remove("active"),s.classList.remove("active"),this.viewMode){case"current":e.classList.add("active");break;case"all":i.classList.add("active");break;case"collections":s.classList.add("active");break}}}captureScrollPosition(){this.contentAreaEl&&(this.savedScrollPosition=this.contentAreaEl.scrollTop)}restoreScrollPosition(){this.contentAreaEl&&!this.isHighlightFocusing&&!this.isColorChanging&&requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=this.savedScrollPosition})}restoreSelectedHighlight(){this.plugin.selectedHighlightId&&requestAnimationFrame(()=>{this.containerEl.querySelectorAll(".selected, .highlight-selected").forEach(i=>{i.classList.remove("selected","highlight-selected"),i.style.removeProperty("border-left-color"),i.style.removeProperty("box-shadow")});let e=this.containerEl.querySelector(`[data-highlight-id="${this.plugin.selectedHighlightId}"]`);if(e){e.classList.add("selected");let i=this.plugin.selectedHighlightId?this.getHighlightById(this.plugin.selectedHighlightId):null;i&&(e.classList.add("highlight-selected"),this.applyHighlightColorStyling(e,i))}})}applyHighlightColorStyling(t,e){let i=e.color||this.plugin.settings.highlightColor;t.style.borderLeftColor=i,e.isNativeComment||(t.style.boxShadow=`0 0 0 1.5px ${i}, var(--shadow-s)`)}updateContent(){this.renderContent()}updateItem(t){var l;let e=this.containerEl.querySelector(`[data-highlight-id="${t}"]`);if(!e)return;let i=this.getHighlightById(t);if(!i){e.remove();return}let s=document.createElement("div"),n=this.viewMode==="all";this.createHighlightItem(s,i,this.getSearchTerm(),n);let a=s.firstElementChild;a&&((l=e.parentNode)==null||l.replaceChild(a,e),this.plugin.selectedHighlightId===t&&(a.classList.add("selected"),a.classList.add("highlight-selected"),this.applyHighlightColorStyling(a,i)))}getSearchTerm(){let t=this.containerEl.querySelector(".highlights-search-input");return(t==null?void 0:t.value)||""}renderContent(){this.captureScrollPosition(),this.viewMode==="collections"?this.currentCollectionId?(this.enableSearchAndToolbar(),this.renderCollectionDetailView(this.currentCollectionId)):(this.disableSearchAndToolbar(),this.renderCollectionsView()):(this.enableSearchAndToolbar(),this.renderFilteredList());let t=this.contentEl.querySelector(".highlights-search-container button:last-of-type");t&&this.updateCollectionNavButton(t),this.restoreScrollPosition()}renderCollectionsView(){this.captureScrollPosition(),this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list collections-container"});let t=this.plugin.collectionsManager.getAllCollections();t.length===0?this.renderEmptyCollectionsState(this.listContainerEl):this.renderCollectionsGrid(this.listContainerEl,t),this.restoreScrollPosition()}renderEmptyCollectionsState(t){t.createEl("p",{text:"No collections."})}renderCollectionsGrid(t,e){let i=t.createDiv({cls:"collections-grid"});e.forEach(s=>{let n=i.createDiv({cls:"collection-card"});n.setAttribute("data-collection-id",s.id);let a=n.createDiv({cls:"collection-menu-btn"});(0,v.setIcon)(a,"ellipsis-vertical"),a.addEventListener("click",x=>{x.stopPropagation(),this.showCollectionMenu(x,s)});let l=n.createDiv({cls:"collection-name"});l.textContent=s.name;let o=n.createDiv({cls:"collection-description"});s.description&&s.description.trim()?o.textContent=s.description:(o.textContent="No description",o.classList.add("collection-description-empty"));let c=n.createDiv({cls:"collection-stats"}),h=this.plugin.collectionsManager.getCollectionStats(s.id),g=c.createEl("small",{cls:"collection-info-line"}),d=g.createDiv({cls:"highlight-line-info"}),f=d.createDiv({cls:"line-icon"});if((0,v.setIcon)(f,"highlighter"),d.createSpan({text:`${h.highlightCount}`}),this.showNativeComments){let x=g.createDiv({cls:"highlight-line-info"}),C=x.createDiv({cls:"line-icon"});(0,v.setIcon)(C,"captions"),x.createSpan({text:`${h.nativeCommentsCount}`})}let u=g.createDiv({cls:"highlight-line-info"}),p=u.createDiv({cls:"line-icon"});(0,v.setIcon)(p,"file-text"),u.createSpan({text:`${h.fileCount}`}),n.addEventListener("click",()=>{this.currentCollectionId=s.id,this.renderContent()})})}renderCollectionDetailView(t){this.captureScrollPosition();let e=this.plugin.collectionsManager.getCollection(t);if(!e){new v.Notice("Collection not found"),this.currentCollectionId=null,this.renderContent();return}this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"});let i=this.plugin.collectionsManager.getHighlightsInCollection(t);i.length===0?this.renderEmptyCollectionState(this.listContainerEl,e):this.renderCollectionHighlights(i),this.restoreScrollPosition()}renderEmptyCollectionState(t,e){t.createEl("p",{text:"No highlights in collection."})}renderCollectionHighlights(t){var s;let e=((s=this.searchInputEl)==null?void 0:s.value.toLowerCase().trim())||"",i=this.applyAllFilters(t);if(i.length===0){let n=e?"No matching highlights in collection.":"No highlights in collection.";this.listContainerEl.createEl("p",{text:n});return}this.groupingMode==="none"?i.sort((a,l)=>a.filePath!==l.filePath?a.filePath.localeCompare(l.filePath):a.startOffset-l.startOffset).forEach(a=>{this.createHighlightItem(this.listContainerEl,a,e,!0)}):this.renderGroupedHighlights(i,e,!0)}renderFilteredList(){if(!this.contentAreaEl||!this.listContainerEl)return;this.captureScrollPosition(),this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"});let t=this.searchInputEl?this.searchInputEl.value.toLowerCase().trim():"";this.listContainerEl.empty();let e;if(this.viewMode==="current"){if(!this.plugin.app.workspace.getActiveFile()){this.listContainerEl.createEl("p",{text:"No file open."}),this.restoreScrollPosition(),this.showTagActive();return}e=this.plugin.getCurrentFileHighlights()}else if(this.viewMode==="all"){e=[];for(let[s,n]of this.plugin.highlights)e.push(...n)}else return;let i=this.applyAllFilters(e);if(i.length===0){let s;if(this.viewMode==="current"){let n=this.plugin.app.workspace.getActiveFile();n&&n.extension==="pdf"?s="PDF highlights are not supported.":s=t?"No matching highlights.":"No highlights in this file."}else s=t?"No matching highlights across all files.":"No highlights found across all files.";this.listContainerEl.createEl("p",{text:s})}else if(this.groupingMode==="none"){let s=i.sort((n,a)=>n.filePath!==a.filePath?n.filePath.localeCompare(a.filePath):n.startOffset-a.startOffset);this.viewMode==="all"?this.renderHighlightsWithPagination(s,t):s.forEach(n=>{this.createHighlightItem(this.listContainerEl,n,t,!1)})}else this.viewMode==="all"?this.renderGroupedHighlightsWithPagination(i,t):this.renderGroupedHighlights(i,t,!1);this.showTagActive(),this.restoreScrollPosition()}renderHighlightsWithPagination(t,e){this.totalHighlights=t,this.isPreservingPagination||(this.currentPage=0);let i=Math.max(0,Math.ceil(t.length/this.itemsPerPage)-1);this.currentPage>i&&(this.currentPage=i),this.renderCurrentPage(e),this.renderPaginationControls(),this.isPreservingPagination=!1}renderCurrentPage(t){let e=this.currentPage*this.itemsPerPage,i=Math.min(e+this.itemsPerPage,this.totalHighlights.length),s=this.totalHighlights.slice(e,i);this.listContainerEl.empty(),s.forEach(n=>{this.createHighlightItem(this.listContainerEl,n,t,!0)})}renderPaginationControls(){let t=this.listContainerEl.querySelector(".pagination-controls");t&&t.remove();let e=Math.ceil(this.totalHighlights.length/this.itemsPerPage);if(e<=1)return;let i=this.listContainerEl.createDiv({cls:"pagination-controls"}),s=i.createEl("button",{cls:"clickable-icon"});s.disabled=this.currentPage===0,(0,v.setIcon)(s,"chevron-left"),s.addEventListener("click",()=>{this.currentPage>0&&(this.currentPage--,this.renderCurrentPage(this.getSearchTerm()),this.renderPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))});let n=i.createSpan({text:`${this.currentPage+1}/${e}`,cls:"pagination-info pagination-info-compact"}),a=i.createEl("button",{cls:"clickable-icon"});a.disabled=this.currentPage>=e-1,(0,v.setIcon)(a,"chevron-right"),a.addEventListener("click",()=>{this.currentPage<e-1&&(this.currentPage++,this.renderCurrentPage(this.getSearchTerm()),this.renderPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))})}renderGroupedHighlightsWithPagination(t,e){let i=new Map,s=new Map;t.forEach(o=>{var h;let c;if(this.groupingMode==="color"){let g=o.color||this.plugin.settings.highlightColor;c=g,s.set(c,g)}else if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){let g=o.isNativeComment?0:((h=o.footnoteContents)==null?void 0:h.filter(d=>d.trim()!=="").length)||0;c=g===0?"No Comments":g===1?"1 Comment":`${g} Comments`}else if(this.groupingMode==="parent"){let g=o.filePath.split("/");g.length>1?c=g[g.length-2]:c="Root"}else if(this.groupingMode==="collection"){let g=this.plugin.collectionsManager.getAllCollections().filter(d=>d.highlightIds.includes(o.id));g.length===0?c="No Collections":g.length===1?c=g[0].name:c=g.map(d=>d.name).sort().join(", ")}else if(this.groupingMode==="filename")c=(o.filePath.split("/").pop()||o.filePath).replace(/\.md$/,"");else if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc")if(o.createdAt){let g=new Date(o.createdAt),d=g.getFullYear(),f=String(g.getMonth()+1).padStart(2,"0"),u=String(g.getDate()).padStart(2,"0");c=`${d}-${f}-${u}`}else c="No Date";else c="Default";i.has(c)||i.set(c,[]),i.get(c).push(o)});let n=Array.from(i.entries()).map(([o,c])=>{let h;return this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?h=c.sort((g,d)=>{let f=g.createdAt||0,u=d.createdAt||0;return this.groupingMode==="date-created-asc"?f-u:u-f}):h=c.sort((g,d)=>g.startOffset-d.startOffset),[o,h]}).sort(([o],[c])=>{if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){if(o==="No Comments"&&c==="No Comments")return 0;if(o==="No Comments")return this.groupingMode==="comments-asc"?-1:1;if(c==="No Comments")return this.groupingMode==="comments-asc"?1:-1;let h=parseInt(o.split(" ")[0])||0,g=parseInt(c.split(" ")[0])||0;return this.groupingMode==="comments-asc"?h-g:g-h}else{if(this.groupingMode==="tag")return o==="No Tags"&&c==="No Tags"?0:o==="No Tags"?1:c==="No Tags"?-1:o.localeCompare(c);if(this.groupingMode==="parent")return o==="Root"&&c==="Root"?0:o==="Root"?-1:c==="Root"?1:o.localeCompare(c);if(this.groupingMode==="collection")return o==="No Collections"&&c==="No Collections"?0:o==="No Collections"?1:c==="No Collections"?-1:o.localeCompare(c);if(this.groupingMode==="filename")return o.localeCompare(c);if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"){if(o==="No Date"&&c==="No Date")return 0;if(o==="No Date")return 1;if(c==="No Date")return-1;let h=new Date(o),g=new Date(c);return this.groupingMode==="date-created-asc"?h.getTime()-g.getTime():g.getTime()-h.getTime()}}return o.localeCompare(c)});this.totalGroups=n,this.isPreservingPagination||(this.currentGroupPage=0);let a=n.reduce((o,[,c])=>o+c.length,0),l=Math.max(0,Math.ceil(a/this.itemsPerPage)-1);this.currentGroupPage>l&&(this.currentGroupPage=l),this.renderCurrentGroupPage(e,s),this.renderGroupPaginationControls(),this.isPreservingPagination=!1}renderCurrentGroupPage(t,e){let i=this.currentGroupPage*this.itemsPerPage,s=i+this.itemsPerPage;this.listContainerEl.empty();let n=0,a=0;for(let[l,o]of this.totalGroups){let c=o.length;if(n+c>i&&n<s){let h=Math.max(0,i-n),g=Math.min(c,s-n),d=o.slice(h,g);d.length>0&&(this.renderGroupHeader(l,o,e),d.forEach(f=>{this.createHighlightItem(this.listContainerEl,f,t,!0),a++}))}if(n+=c,n>=s)break}}renderGroupHeader(t,e,i){let s=this.listContainerEl.createDiv({cls:"highlight-group-header"}),n=s.createSpan();if(this.groupingMode==="color"&&(i!=null&&i.has(t))){let C=i.get(t),H=n.createDiv({cls:"group-color-square",attr:{"data-color":C}});H.style.backgroundColor=C}if(this.groupingMode==="tag"){let C=n.createDiv({cls:"group-tag-icon"});(0,v.setIcon)(C,"tag")}let a=n.createSpan();a.textContent=this.groupingMode==="color"?this.getColorName(t):t;let o=s.createDiv({cls:"collection-stats"}).createEl("small",{cls:"collection-info-line"}),h=new Set(e.map(C=>C.filePath)).size,g=e.filter(C=>C.isNativeComment).length,d=e.filter(C=>!C.isNativeComment).length,f=o.createDiv({cls:"highlight-line-info"}),u=f.createDiv({cls:"line-icon"});if((0,v.setIcon)(u,"highlighter"),f.createSpan({text:`${d}`}),this.showNativeComments){let C=o.createDiv({cls:"highlight-line-info"}),H=C.createDiv({cls:"line-icon"});(0,v.setIcon)(H,"captions"),C.createSpan({text:`${g}`})}let p=o.createDiv({cls:"highlight-line-info"}),x=p.createDiv({cls:"line-icon"});(0,v.setIcon)(x,"files"),p.createSpan({text:`${h}`})}renderSingleGroup(t,e,i,s=!1,n){this.renderGroupHeader(t,e,n);let a;this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?a=e.sort((l,o)=>{let c=l.createdAt||0,h=o.createdAt||0;return this.groupingMode==="date-created-asc"?c-h:h-c}):a=e.sort((l,o)=>l.startOffset-o.startOffset),a.forEach(l=>{this.createHighlightItem(this.listContainerEl,l,i,s)})}renderGroupPaginationControls(){let t=this.listContainerEl.querySelector(".pagination-controls");t&&t.remove();let e=this.totalGroups.reduce((o,[,c])=>o+c.length,0),i=Math.ceil(e/this.itemsPerPage);if(i<=1)return;let s=this.listContainerEl.createDiv({cls:"pagination-controls"}),n=s.createEl("button",{cls:"clickable-icon"});n.disabled=this.currentGroupPage===0,(0,v.setIcon)(n,"chevron-left"),n.addEventListener("click",()=>{this.currentGroupPage>0&&(this.currentGroupPage--,this.renderCurrentGroupPage(this.getSearchTerm()),this.renderGroupPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))});let a=s.createSpan({text:`${this.currentGroupPage+1}/${i}`,cls:"pagination-info pagination-info-compact"}),l=s.createEl("button",{cls:"clickable-icon"});l.disabled=this.currentGroupPage>=i-1,(0,v.setIcon)(l,"chevron-right"),l.addEventListener("click",()=>{this.currentGroupPage<i-1&&(this.currentGroupPage++,this.renderCurrentGroupPage(this.getSearchTerm()),this.renderGroupPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))})}updateGroupButtonState(t){this.groupingMode==="none"?t.classList.remove("active"):t.classList.add("active")}saveGroupingModeToSettings(){this.plugin.settings.groupingMode=this.groupingMode,this.plugin.saveSettings()}createHighlightItem(t,e,i,s=!1){let l={searchTerm:this.currentSearchTokens.filter(o=>o.type==="text"&&!o.exclude).map(o=>o.value).join(" ")||i,showFilename:this.plugin.settings.showFilenames&&s,showTimestamp:this.plugin.settings.showTimestamps,showHighlightActions:this.plugin.settings.showHighlightActions,isCommentsVisible:this.getHighlightCommentsVisibility(e),dateFormat:this.plugin.settings.dateFormat,onCommentToggle:o=>{let c=this.highlightCommentsVisible.get(o)||!1;this.highlightCommentsVisible.set(o,!c),this.rerenderCurrentView()},onCollectionsMenu:(o,c)=>{this.showCollectionsMenu(o,c)},onColorChange:(o,c)=>{this.preservedScrollTop=this.contentAreaEl.scrollTop,this.isColorChanging=!0,window.setTimeout(()=>{this.isColorChanging=!1},2e3),this.changeHighlightColor(o,c),this.rerenderCurrentView(),requestAnimationFrame(()=>{if(this.contentAreaEl&&this.isColorChanging&&(this.contentAreaEl.scrollTop=this.preservedScrollTop,this.isColorChanging=!1,this.plugin.selectedHighlightId)){let h=this.containerEl.querySelector(`[data-highlight-id="${this.plugin.selectedHighlightId}"]`);if(h){let g=this.getHighlightById(this.plugin.selectedHighlightId);if(g){let d=g.color||this.plugin.settings.highlightColor;h.style.borderLeftColor=d,g.isNativeComment||(h.style.boxShadow=`0 0 0 1.5px ${d}, var(--shadow-s)`)}}}})},onHighlightClick:(o,c)=>{this.focusHighlightInEditor(o,c)},onAddComment:async o=>{this.isPreservingPagination=!0,await this.focusHighlightInEditor(o),this.addFootnoteToHighlightWithTargetedUpdate(o)},onCommentClick:(o,c,h)=>{var f;let g=-1,d=0;for(let u=0;u<(((f=o.footnoteContents)==null?void 0:f.length)||0);u++)if(o.footnoteContents[u].trim()!==""){if(d===c){g=u;break}d++}g!==-1&&this.focusFootnoteInEditor(o,g,h)},onTagClick:o=>{this.selectedTags.has(o)?this.selectedTags.delete(o):this.selectedTags.add(o),this.renderFilteredList(),this.showTagActive()},onFileNameClick:(o,c)=>{this.isPreservingPagination=!0,this.plugin.app.workspace.openLinkText(o,o,v.Keymap.isModEvent(c))}};return this.highlightRenderer.createHighlightItem(t,e,l)}rerenderCurrentView(){this.viewMode==="collections"&&this.currentCollectionId?this.renderCollectionDetailView(this.currentCollectionId):this.renderFilteredList()}async addFootnoteToHighlightWithTargetedUpdate(t){let e=this.plugin.app.workspace.getActiveViewOfType(v.MarkdownView);if(!e)return;let i=e.editor,s=e.file;if(!s)return;let a=i.getValue().split(`
`),l=-1,o=null;for(let c=0;c<a.length;c++){let h=a[c];if(t.isNativeComment){if(h.includes(`%%${t.text}%%`)){l=c;let g=h.indexOf(`%%${t.text}%%`)+`%%${t.text}%%`.length,d=h.substring(g),f=d.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),u=f?f[0].length:0;if(u>0&&d.length>u){let p=d.substring(u);if(!p.match(/^\S/)){let x=p.match(/^(\s+)/);if(x){let C=x[1];p.substring(x[0].length).length===0&&(u+=x[0].length)}}}else if(u>0){let p=d.substring(u).match(/^\s+/);p&&(u+=p[0].length)}o={line:c,ch:g+u};break}}else if(this.isHtmlHighlight(t)){let g=this.getHtmlHighlightPatterns(t),d=!1;for(let{pattern:f}of g){let p=new RegExp(f,"gi").exec(h);if(p){l=c;let x=p.index+p[0].length,C=h.substring(x),H=C.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),T=H?H[0].length:0;if(T>0&&C.length>T){let m=C.substring(T);if(!m.match(/^\S/)){let w=m.match(/^(\s+)/);if(w){let S=w[1];m.substring(w[0].length).length===0&&(T+=w[0].length)}}}else if(T>0){let m=C.substring(T).match(/^\s+/);m&&(T+=m[0].length)}o={line:c,ch:x+T},d=!0;break}}if(d)break}else if(h.includes(`==${t.text}==`)){l=c;let g=h.indexOf(`==${t.text}==`)+`==${t.text}==`.length,d=h.substring(g),f=d.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),u=f?f[0].length:0;if(u>0&&d.length>u){let p=d.substring(u);if(!p.match(/^\S/)){let x=p.match(/^(\s+)/);if(x){let C=x[1];p.substring(x[0].length).length===0&&(u+=x[0].length)}}}else if(u>0){let p=d.substring(u).match(/^\s+/);p&&(u+=p[0].length)}o={line:c,ch:g+u};break}}if(!o){new v.Notice("Could not find the highlight in the editor. It might have been modified.");return}i.setCursor(o),i.focus(),this.plugin.settings.useInlineFootnotes?this.plugin.inlineFootnoteManager.insertInlineFootnote(i,t,"")?setTimeout(async()=>{await this.updateSingleHighlightFromEditor(t,s)},50):new v.Notice("Could not insert inline footnote."):(this.plugin.app.commands.executeCommandById("editor:insert-footnote"),setTimeout(async()=>{await this.updateSingleHighlightFromEditor(t,s)},100))}async updateSingleHighlightFromEditor(t,e){let i=this.plugin.app.workspace.getActiveViewOfType(v.MarkdownView);if(!i)return;let s=i.editor.getValue(),n=this.plugin.extractFootnotes(s),a=this.findAndParseHighlight(s,t,n);if(a){let l=this.plugin.highlights.get(e.path)||[],o=l.findIndex(c=>c.id===t.id);o!==-1&&(l[o]=a,this.plugin.highlights.set(e.path,l),await this.plugin.saveSettings(),this.updateItem(t.id))}}findAndParseHighlight(t,e,i){let s=e.isNativeComment?new RegExp(`%%${this.escapeRegex(e.text)}%%`,"g"):new RegExp(`==${this.escapeRegex(e.text)}==`,"g"),n;for(;(n=s.exec(t))!==null;)if(Math.abs(n.index-e.startOffset)<100){let a=t.slice(n.index+n[0].length),l=[];this.plugin.inlineFootnoteManager.extractInlineFootnotes(t,n.index+n[0].length).forEach(u=>{u.content.trim()&&l.push({type:"inline",index:u.startIndex,content:u.content.trim()})});let c=/(\s*\[\^(\w+)\])(?!:)/g,h,g=0;for(;(h=c.exec(a))!==null;){let u=a.substring(g,h.index),p=/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/.test(u);if(h.index===g||p){let x=h[2];if(i.has(x)){let C=i.get(x).trim();C&&l.push({type:"standard",index:n.index+n[0].length+h.index,content:C})}g=h.index+h[0].length}else break}l.sort((u,p)=>u.index-p.index);let d=l.map(u=>u.content),f=d.length;return{...e,footnoteCount:f,footnoteContents:d,startOffset:n.index,endOffset:n.index+n[0].length}}return null}async focusHighlightInEditor(t,e){var o;this.isPreservingPagination=!0,this.containerEl.querySelectorAll(".selected, .highlight-selected").forEach(c=>{c.classList.remove("selected","highlight-selected"),c.style.removeProperty("border-left-color"),c.style.removeProperty("box-shadow")});let s=this.plugin.selectedHighlightId;this.plugin.selectedHighlightId=t.id;let n=this.containerEl.querySelector(`[data-highlight-id="${t.id}"]`);if(n){n.classList.add("selected");let c=this.plugin.highlights.get(t.filePath),h=c==null?void 0:c.find(g=>g.id===t.id);if(h){n.classList.add("highlight-selected");let g=h.color||this.plugin.settings.highlightColor;n.style.borderLeftColor=g,h.isNativeComment||(n.style.boxShadow=`0 0 0 1.5px ${g}, var(--shadow-s)`)}}if(this.isHighlightFocusing)return;this.preservedScrollTop=this.contentAreaEl.scrollTop,this.isHighlightFocusing=!0,window.setTimeout(()=>{this.isHighlightFocusing=!1},2e3);let a=null,l=this.plugin.app.workspace.getActiveViewOfType(v.MarkdownView);if(l&&l.file&&l.file.path===t.filePath)a=l;else{let c=this.plugin.app.workspace.getLeavesOfType("markdown");for(let h of c)if(h.view instanceof v.MarkdownView&&((o=h.view.file)==null?void 0:o.path)===t.filePath){a=h.view,this.plugin.app.workspace.setActiveLeaf(h,{focus:!0});break}}if(!a&&this.plugin.app.vault.getAbstractFileByPath(t.filePath)instanceof v.TFile){let h=await this.plugin.app.workspace.openLinkText(t.filePath,t.filePath,e?v.Keymap.isModEvent(e):!1);return new Promise(g=>{let d=()=>{var u;let f=this.plugin.app.workspace.getActiveViewOfType(v.MarkdownView);f&&((u=f.file)==null?void 0:u.path)===t.filePath?(this.performHighlightFocus(f,t),g()):window.setTimeout(d,50)};window.setTimeout(d,100)})}a&&requestAnimationFrame(()=>{this.performHighlightFocus(a,t)})}isHtmlHighlight(t){return t.type==="html"}getHtmlHighlightPatterns(t){let e=this.escapeRegex(t.text),i=[];return i.push({pattern:`<span\\s+style=["'][^"']*background:\\s*[^;"']+[^"']*["'][^>]*>${e}<\\/span>`,tagLength:0}),i.push({pattern:`<font\\s+color=["'][^"']+["'][^>]*>${e}<\\/font>`,tagLength:0}),i.push({pattern:`<mark[^>]*>${e}<\\/mark>`,tagLength:0}),i.push({pattern:`<span\\s+class=["'][^"']*["'][^>]*>${e}<\\/span>`,tagLength:0}),i}performHighlightFocus(t,e){if(!t||!t.editor)return;this.contentAreaEl.scrollTop!==this.preservedScrollTop?requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=this.preservedScrollTop,this.isHighlightFocusing=!1}):this.isHighlightFocusing=!1;let s=t.editor.getValue(),n=[];if(e.isNativeComment){let g=`%%${this.escapeRegex(e.text)}%%`,d=new RegExp(g,"g"),f;for(;(f=d.exec(s))!==null;)n.push({index:f.index,length:f[0].length,tagStartLength:2,tagEndLength:2})}else if(this.isHtmlHighlight(e)){let g=this.getHtmlHighlightPatterns(e);for(let{pattern:d}of g){let f=new RegExp(d,"gi"),u;for(;(u=f.exec(s))!==null;){let p=u[0],x=p.lastIndexOf(e.text),C=x,H=p.length-x-e.text.length;n.push({index:u.index,length:u[0].length,tagStartLength:C,tagEndLength:H})}}}else{let g=`==${this.escapeRegex(e.text)}==`,d=new RegExp(g,"g"),f;for(;(f=d.exec(s))!==null;)n.push({index:f.index,length:f[0].length,tagStartLength:2,tagEndLength:2})}if(n.length===0)return;let a=n[0],l=1/0,o=!1;for(let g of n){let d=Math.abs(g.index-e.startOffset);d<l&&(l=d,a=g,o=!0)}!o||l>50;let c=t.editor.offsetToPos(a.index+a.tagStartLength),h=t.editor.offsetToPos(a.index+a.length-a.tagEndLength);if(t.editor.setSelection(c,h),this.plugin.settings.autoToggleFold)try{this.plugin.app.commands.executeCommandById("editor:toggle-fold")}catch(g){console.warn("Failed to execute toggle fold command:",g)}t.editor.scrollIntoView({from:c,to:h},!0),t.editor.focus()}focusHighlight(t){let e=this.containerEl.querySelector(`[data-highlight-id="${t}"]`)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async focusFootnoteInEditor(t,e,i){var a;let s=null,n=this.plugin.app.workspace.getActiveViewOfType(v.MarkdownView);if(n&&n.file&&n.file.path===t.filePath)s=n;else{let l=this.plugin.app.workspace.getLeavesOfType("markdown");for(let o of l)if(o.view instanceof v.MarkdownView&&((a=o.view.file)==null?void 0:a.path)===t.filePath){s=o.view,this.plugin.app.workspace.setActiveLeaf(o,{focus:!0});break}}if(!s&&this.plugin.app.vault.getAbstractFileByPath(t.filePath)instanceof v.TFile){await this.plugin.app.workspace.openLinkText(t.filePath,t.filePath,i?v.Keymap.isModEvent(i):!1),window.setTimeout(()=>this.focusFootnoteInEditor(t,e,i),200);return}window.setTimeout(()=>{let l=this.plugin.app.workspace.getActiveViewOfType(v.MarkdownView);if(!l||!l.editor){new v.Notice("Could not access the editor.");return}let o=l.editor,c=o.getValue(),h=this.escapeRegex(t.text),g=null,d=1/0;if(t.isNativeComment){let w=`%%${h}%%`,S=new RegExp(w,"g"),b;for(;(b=S.exec(c))!==null;){let y=Math.abs(b.index-t.startOffset);y<d&&(d=y,g={index:b.index,length:b[0].length})}}else if(this.isHtmlHighlight(t)){let w=this.getHtmlHighlightPatterns(t);for(let{pattern:S}of w){let b=new RegExp(S,"gi"),y;for(;(y=b.exec(c))!==null;){let k=Math.abs(y.index-t.startOffset);k<d&&(d=k,g={index:y.index,length:y[0].length})}}}else{let w=`==${h}==`,S=new RegExp(w,"g"),b;for(;(b=S.exec(c))!==null;){let y=Math.abs(b.index-t.startOffset);y<d&&(d=y,g={index:b.index,length:b[0].length})}}if(!g){new v.Notice("Could not find the highlight in the editor.");return}let f=new B,u=c.substring(g.index+g.length),p=[];f.extractInlineFootnotes(c,g.index+g.length).forEach(w=>{p.push({type:"inline",content:w.content,startIndex:w.startIndex,endIndex:w.endIndex})});let C=/(\s*\[\^(\w+)\])/g,H,T=0;for(;(H=C.exec(u))!==null;){let w=u.substring(T,H.index),S=/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/.test(w);if(H.index===T||S)p.push({type:"standard",content:H[2],startIndex:g.index+g.length+H.index,endIndex:g.index+g.length+H.index+H[0].length}),T=H.index+H[0].length;else break}if(p.sort((w,S)=>w.startIndex-S.startIndex),p.length===0){new v.Notice("No footnotes found for this highlight.");return}if(e>=p.length){new v.Notice("Footnote index out of range.");return}let m=p[e];if(m.type==="inline"){let w=c.substring(m.startIndex,m.endIndex),S=w.indexOf("^"),b=m.startIndex+S,y=o.offsetToPos(b);if(this.plugin.settings.selectTextOnCommentClick){let k=m.startIndex+w.indexOf("[")+1,N=m.startIndex+w.lastIndexOf("]"),M=o.offsetToPos(k),F=o.offsetToPos(N);o.scrollIntoView({from:M,to:F},!0),o.setSelection(M,F),o.focus()}else o.scrollIntoView({from:y,to:y},!0),o.setCursor(y),o.focus()}else{let w=m.content,S=new RegExp(`^\\[\\^${this.escapeRegex(w)}\\]:\\s*(.+)$`,"m"),b=c.match(S);if(!b){new v.Notice("Could not find footnote definition.");return}let y=c.indexOf(b[0]),k=o.offsetToPos(y);if(this.plugin.settings.selectTextOnCommentClick){let N=b[1],M=y+b[0].indexOf(N),F=M+N.length,O=o.offsetToPos(M),tt=o.offsetToPos(F);o.scrollIntoView({from:O,to:tt},!0),o.setSelection(O,tt),o.focus()}else o.scrollIntoView({from:k,to:k},!0),o.setCursor(k),o.focus()}},150)}changeHighlightColor(t,e){this.plugin.updateHighlight(t.id,{color:e},t.filePath)}getColorName(t){let e=this.plugin.settings.customColorNames,i=this.plugin.settings.customColors;return t===i.yellow&&e.yellow.trim()?e.yellow.trim():t===i.red&&e.red.trim()?e.red.trim():t===i.teal&&e.teal.trim()?e.teal.trim():t===i.blue&&e.blue.trim()?e.blue.trim():t===i.green&&e.green.trim()?e.green.trim():t}renderGroupedHighlights(t,e,i=!1){let s=new Map,n=new Map;t.forEach(l=>{var c;let o;if(this.groupingMode==="color"){let h=l.color||this.plugin.settings.highlightColor;o=h,n.set(o,h)}else if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){let h=l.isNativeComment?0:((c=l.footnoteContents)==null?void 0:c.filter(g=>g.trim()!=="").length)||0;o=h===0?"No Comments":h===1?"1 Comment":`${h} Comments`}else if(this.groupingMode==="parent"){let h=l.filePath.split("/");h.length>1?o=h[h.length-2]:o="Root"}else if(this.groupingMode==="collection"){let h=this.plugin.collectionsManager.getAllCollections().filter(g=>g.highlightIds.includes(l.id));h.length===0?o="No Collections":h.length===1?o=h[0].name:o=h.map(g=>g.name).sort().join(", ")}else if(this.groupingMode==="filename")o=(l.filePath.split("/").pop()||l.filePath).replace(/\.md$/,"");else if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc")if(l.createdAt){let h=new Date(l.createdAt),g=h.getFullYear(),d=String(h.getMonth()+1).padStart(2,"0"),f=String(h.getDate()).padStart(2,"0");o=`${g}-${d}-${f}`}else o="No Date";else o="Default";s.has(o)||s.set(o,[]),s.get(o).push(l)}),Array.from(s.entries()).sort(([l],[o])=>{if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){if(l==="No Comments"&&o==="No Comments")return 0;if(l==="No Comments")return this.groupingMode==="comments-asc"?-1:1;if(o==="No Comments")return this.groupingMode==="comments-asc"?1:-1;let c=parseInt(l.split(" ")[0])||0,h=parseInt(o.split(" ")[0])||0;return this.groupingMode==="comments-asc"?c-h:h-c}else{if(this.groupingMode==="tag")return l==="No Tags"&&o==="No Tags"?0:l==="No Tags"?1:o==="No Tags"?-1:l.localeCompare(o);if(this.groupingMode==="parent")return l==="Root"&&o==="Root"?0:l==="Root"?-1:o==="Root"?1:l.localeCompare(o);if(this.groupingMode==="collection")return l==="No Collections"&&o==="No Collections"?0:l==="No Collections"?1:o==="No Collections"?-1:l.localeCompare(o);if(this.groupingMode==="filename")return l.localeCompare(o);if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"){if(l==="No Date"&&o==="No Date")return 0;if(l==="No Date")return 1;if(o==="No Date")return-1;let c=new Date(l),h=new Date(o);return this.groupingMode==="date-created-asc"?c.getTime()-h.getTime():h.getTime()-c.getTime()}}return l.localeCompare(o)}).forEach(([l,o])=>{let c=this.listContainerEl.createDiv({cls:"highlight-group-header"}),h=c.createSpan();if(this.groupingMode==="color"&&n.has(l)){let b=n.get(l),y=h.createDiv({cls:"group-color-square",attr:{"data-color":b}});y.style.backgroundColor=b}if(this.groupingMode==="tag"){let b=h.createDiv({cls:"group-tag-icon"});(0,v.setIcon)(b,"tag")}let g=h.createSpan();g.textContent=this.groupingMode==="color"?this.getColorName(l):l;let f=c.createDiv({cls:"collection-stats"}).createEl("small",{cls:"collection-info-line"}),p=new Set(o.map(b=>b.filePath)).size,x=o.filter(b=>b.isNativeComment).length,C=o.filter(b=>!b.isNativeComment).length,H=f.createDiv({cls:"highlight-line-info"}),T=H.createDiv({cls:"line-icon"});if((0,v.setIcon)(T,"highlighter"),H.createSpan({text:`${C}`}),this.showNativeComments){let b=f.createDiv({cls:"highlight-line-info"}),y=b.createDiv({cls:"line-icon"});(0,v.setIcon)(y,"captions"),b.createSpan({text:`${x}`})}let m=f.createDiv({cls:"highlight-line-info"}),w=m.createDiv({cls:"line-icon"});(0,v.setIcon)(w,"file-text"),m.createSpan({text:`${p}`});let S;this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?S=o.sort((b,y)=>{let k=b.createdAt||0,N=y.createdAt||0;return this.groupingMode==="date-created-asc"?k-N:N-k}):S=o.sort((b,y)=>b.startOffset-y.startOffset),S.forEach(b=>{this.createHighlightItem(this.listContainerEl,b,e,i)})})}updateCommentsToggleIcon(t){t.empty();let i=this.areCommentsGloballyExpanded()?"chevrons-down-up":"chevrons-up-down";(0,v.setIcon)(t,i)}toggleAllComments(){let t=[];for(let[,s]of this.plugin.highlights)t.push(...s);let i=!this.areCommentsGloballyExpanded();t.forEach(s=>{var a;if(s.isNativeComment)return;(((a=s.footnoteContents)==null?void 0:a.filter(l=>l.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.set(s.id,i)})}areCommentsGloballyExpanded(){let t=[];for(let[,e]of this.plugin.highlights)t.push(...e);return t.some(e=>{var s;return e.isNativeComment?!1:(((s=e.footnoteContents)==null?void 0:s.filter(n=>n.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.get(e.id)})}getHighlightCommentsVisibility(t){var i;let e=this.highlightCommentsVisible.get(t.id);if(e!==void 0)return e;if(!t.isNativeComment&&(((i=t.footnoteContents)==null?void 0:i.filter(n=>n.trim()!=="").length)||0)>0){let n=this.areCommentsGloballyExpanded();return this.highlightCommentsVisible.set(t.id,n),n}return!1}resetAllColors(){let t;if(this.viewMode==="current")t=this.plugin.getCurrentFileHighlights();else if(this.viewMode==="all"){t=[];for(let[,i]of this.plugin.highlights)t.push(...i)}else this.viewMode==="collections"&&this.currentCollectionId?t=this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId):t=[];let e=!1;t.forEach(i=>{if(i.color){let s=this.plugin.highlights.get(i.filePath);if(s){let n=s.find(a=>a.id===i.id);if(n&&n.color){let a={...n,color:void 0},l=s.indexOf(n);s[l]=a,this.plugin.highlights.set(i.filePath,[...s]),e=!0}}}}),e&&(this.plugin.saveSettings(),this.renderContent())}extractTagsFromHighlight(t){let e=[];if(t.footnoteContents){for(let i of t.footnoteContents)if(i.trim()!==""){let s=i.match(/#[\p{L}\p{N}\p{M}_/-]+/gu);s&&s.forEach(n=>{let a=n.substring(1);e.includes(a)||e.push(a)})}}return e}getAllTagsInFile(){let t=new Set;if(this.viewMode==="current")this.plugin.getCurrentFileHighlights().forEach(i=>{this.extractTagsFromHighlight(i).forEach(n=>t.add(n))});else if(this.viewMode==="all")for(let[e,i]of this.plugin.highlights)i.forEach(s=>{this.extractTagsFromHighlight(s).forEach(a=>t.add(a))});else this.viewMode==="collections"&&this.currentCollectionId&&this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId).forEach(i=>{this.extractTagsFromHighlight(i).forEach(n=>t.add(n))});return Array.from(t).sort((e,i)=>e.localeCompare(i,void 0,{numeric:!0,sensitivity:"base"}))}getAllCollectionsInCurrentScope(){let t=new Set,e=[];if(this.viewMode==="current")e=this.plugin.getCurrentFileHighlights();else if(this.viewMode==="all")for(let[s,n]of this.plugin.highlights)e.push(...n);else this.viewMode==="collections"&&this.currentCollectionId&&(e=this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId));return e.forEach(s=>{this.plugin.collectionsManager.getCollectionsForHighlight(s.id).forEach(a=>{t.add(a.id)})}),this.plugin.collectionsManager.getAllCollections().filter(s=>t.has(s.id))}showTagFilterMenu(t){let e=this.getAllTagsInFile(),i=this.getAllCollectionsInCurrentScope();if(e.length===0&&i.length===0){new v.Notice("No tags or collections found");return}let s=i.sort((a,l)=>a.name.localeCompare(l.name,void 0,{numeric:!0,sensitivity:"base"})),n=[{text:"Clear",icon:"x",className:"highlights-dropdown-clear",onClick:()=>{this.selectedTags.clear(),this.selectedCollections.clear(),this.renderContent(),this.showTagActive();let a={};e.forEach(l=>{a[`tag-${l}`]=!1}),s.forEach(l=>{a[`collection-${l.id}`]=!1}),this.dropdownManager.updateAllCheckboxStates(a)}}];e.length>0&&n.push(...e.map(a=>({id:`tag-${a}`,text:`#${a}`,uncheckedIcon:"tag",checked:this.selectedTags.has(a),onClick:()=>{this.selectedTags.has(a)?this.selectedTags.delete(a):this.selectedTags.add(a),this.renderContent(),this.showTagActive()}}))),e.length>0&&s.length>0&&n.push({text:"",separator:!0}),s.length>0&&n.push(...s.map(a=>({id:`collection-${a.id}`,text:a.name,uncheckedIcon:"folder-open",checked:this.selectedCollections.has(a.name),onClick:()=>{this.selectedCollections.has(a.name)?this.selectedCollections.delete(a.name):this.selectedCollections.add(a.name),this.renderContent(),this.showTagActive()}}))),this.dropdownManager.showDropdown(t.currentTarget,n)}showCollectionsMenu(t,e){let i=this.plugin.collectionsManager.getAllCollections(),s=[{text:"Clear",icon:"x",className:"highlights-dropdown-clear",onClick:()=>{i.forEach(a=>{this.plugin.collectionsManager.removeHighlightFromCollection(a.id,e.id)}),this.updateHighlightCollectionCount(e),this.viewMode==="collections"&&this.renderContent(),this.groupingMode==="collection"&&this.renderContent();let n={};i.forEach(a=>{n[`collection-${a.id}`]=!1}),this.dropdownManager.updateAllCheckboxStates(n)}},{text:"New collection",icon:"plus",className:"highlights-dropdown-clear",onClick:()=>{this.showNewCollectionDialog(e.id)}}];i.length>0?s.push(...i.map(n=>({id:`collection-${n.id}`,text:n.name,uncheckedIcon:"folder-open",checked:n.highlightIds.includes(e.id),onClick:()=>{n.highlightIds.includes(e.id)?(this.plugin.collectionsManager.removeHighlightFromCollection(n.id,e.id),this.updateHighlightCollectionCount(e),this.viewMode==="collections"&&this.currentCollectionId===n.id&&this.renderContent(),this.groupingMode==="collection"&&this.renderContent()):(this.plugin.collectionsManager.addHighlightToCollection(n.id,e.id),this.updateHighlightCollectionCount(e),this.groupingMode==="collection"&&this.renderContent())}}))):s.push({text:"No collections available",className:"highlights-dropdown-empty",onClick:()=>{}}),this.dropdownManager.showDropdown(t.currentTarget,s)}updateCollectionNavButton(t){t.empty(),this.viewMode==="collections"&&this.currentCollectionId?((0,v.setIcon)(t,"arrow-left"),(0,v.setTooltip)(t,"Back to Collections"),t.classList.add("active","collection-nav-back")):((0,v.setIcon)(t,"folder-plus"),(0,v.setTooltip)(t,"New collection"),t.classList.remove("active","collection-nav-back"))}toggleSearch(){var e;if(!this.plugin.settings.showToolbar)return;this.searchExpanded=!this.searchExpanded;let t=this.contentEl.querySelector(".highlights-search-input-container");t&&(this.searchExpanded?(t.classList.remove("hidden"),this.searchButton.classList.add("active"),(0,v.setIcon)(this.searchButton,"x"),(0,v.setTooltip)(this.searchButton,"Close search"),window.setTimeout(()=>this.searchInputEl.focus(),100)):(t.classList.add("hidden"),this.searchButton.classList.remove("active"),(0,v.setIcon)(this.searchButton,"search"),(0,v.setTooltip)(this.searchButton,"Search highlights"),(e=this.simpleSearchManager)==null||e.clear(),this.currentSearchTokens=[],this.currentParsedSearch={ast:null},this.renderContent()))}enableSearchAndToolbar(){if(!this.plugin.settings.showToolbar)return;this.searchButton&&this.searchButton.classList.remove("disabled"),this.searchInputEl&&this.searchInputEl.classList.remove("disabled");let t=this.contentEl.querySelectorAll(".highlights-search-container button");t.forEach((i,s)=>{let n=s===t.length-1,a=s===2;this.viewMode==="collections"&&!this.currentCollectionId&&!n&&!a?i.classList.add("disabled"):i.classList.remove("disabled")});let e=this.contentEl.querySelector(".highlights-search-container button:last-of-type");e&&this.updateCollectionNavButton(e)}disableSearchAndToolbar(){if(!this.plugin.settings.showToolbar)return;this.searchButton&&this.searchButton.classList.add("disabled"),this.searchInputEl&&this.searchInputEl.classList.add("disabled");let t=this.contentEl.querySelectorAll(".highlights-search-container button");t.forEach((i,s)=>{s===t.length-1?i.classList.remove("disabled"):i.classList.add("disabled")});let e=this.contentEl.querySelector(".highlights-search-container button:last-of-type");e&&this.updateCollectionNavButton(e)}updateHighlightCollectionCount(t){let e=this.containerEl.querySelector(`[data-highlight-id="${t.id}"]`);if(!e)return;let i=e.querySelector(".highlight-line-info:last-child span");if(i){let s=this.plugin.collectionsManager.getHighlightCollectionCount(t.id);i.textContent=`${s}`}}showTagActive(){if(!this.plugin.settings.showToolbar)return;let t=this.contentEl.querySelector(".highlights-tag-filter-button");t&&(this.selectedTags.size>0||this.selectedCollections.size>0?t.classList.add("active"):t.classList.remove("active"))}showNewCollectionDialog(t){new z(this.plugin.app,(e,i)=>{let s=this.plugin.collectionsManager.createCollection(e,i);t&&this.plugin.collectionsManager.addHighlightToCollection(s.id,t),this.animateCollectionCreation(s.id)}).open()}showCollectionMenu(t,e){let i=new v.Menu;i.addItem(s=>{s.setTitle("Edit").setIcon("edit").onClick(()=>{this.showEditCollectionDialog(e)})}),i.addItem(s=>{s.setTitle("Delete").setIcon("trash").onClick(async()=>{await this.animateCollectionDeletion(e.id)})}),i.showAtMouseEvent(t)}showEditCollectionDialog(t){new W(this.plugin.app,t,(e,i)=>{t.name=e,t.description=i,this.plugin.saveSettings(),this.plugin.refreshSidebar()}).open()}updateNativeCommentsToggleState(t){this.showNativeComments?((0,v.setIcon)(t,"captions"),t.classList.remove("active"),(0,v.setTooltip)(t,"Toggle native comments")):((0,v.setIcon)(t,"captions-off"),t.classList.add("active"),(0,v.setTooltip)(t,"Toggle native comments"))}animateCollectionCreation(t){this.plugin.refreshSidebar(),requestAnimationFrame(()=>{let e=this.contentAreaEl.querySelector(`[data-collection-id="${t}"]`);e&&(e.classList.add("preparing-animation"),requestAnimationFrame(()=>{e.classList.remove("preparing-animation"),e.classList.add("animating-in"),window.setTimeout(()=>{e.classList.remove("animating-in")},400)}))})}async animateCollectionDeletion(t){let e=this.contentAreaEl.querySelector(`[data-collection-id="${t}"]`);if(!e)return await this.plugin.collectionsManager.deleteCollectionWithConfirmation(t);let i=this.plugin.collectionsManager.getCollection(t);return!i||!confirm(`Are you sure you want to delete "${i.name}"?`)?!1:(e.classList.add("animating-out"),new Promise(n=>{window.setTimeout(()=>{this.plugin.collectionsManager.deleteCollection(t),this.plugin.refreshSidebar(),n(!0)},220)}))}toggleNativeCommentsVisibility(){this.showNativeComments=!this.showNativeComments,this.plugin.app.saveLocalStorage("sidebar-highlights-show-native-comments",this.showNativeComments.toString())}handleSearchInput(t,e){this.currentParsedSearch=e,this.currentSearchTokens=P.getTokensFromQuery(t),this.renderContent()}removeSearchToken(t){this.simpleSearchManager.updateSuggestions({tags:this.getAvailableTags(),collections:this.getAvailableCollections()})}getHighlightById(t){for(let[e,i]of this.plugin.highlights){let s=i.find(n=>n.id===t);if(s)return s}return null}getAvailableTags(){let t=new Set;for(let e of this.plugin.highlights.values())for(let i of e)this.extractTagsFromHighlight(i).forEach(n=>t.add(n));return Array.from(t).sort()}getAvailableCollections(){return this.plugin.collectionsManager.getAllCollections().map(t=>t.name).sort()}applyAllFilters(t){return t.filter(e=>{if(!this.passesSmartSearchFilter(e))return!1;if(this.selectedTags.size>0){let n=this.extractTagsFromHighlight(e);if(!Array.from(this.selectedTags).some(l=>n.includes(l)))return!1}if(this.selectedCollections.size>0){let n=this.plugin.collectionsManager.getCollectionsForHighlight(e.id);if(!Array.from(this.selectedCollections).some(l=>n.some(o=>o.name===l)))return!1}if(!this.showNativeComments&&e.isNativeComment)return!1;let s=this.plugin.settings.minimumCharacterCount;return!(s>0&&(e.type==="highlight"||e.type==="html"||e.isNativeComment)&&e.text.length<s)})}passesSmartSearchFilter(t){return this.currentParsedSearch.ast?this.evaluateASTNode(this.currentParsedSearch.ast,t):!0}evaluateASTNode(t,e){if(t.type==="filter"){let i=t,s=this.highlightMatchesFilter(e,i);return i.exclude?!s:s}else if(t.type==="text"){let i=t;return e.text.toLowerCase().includes(i.value.toLowerCase())||e.filePath.toLowerCase().replace(/\.md$/,"").includes(i.value.toLowerCase())}else if(t.type==="operator"){let i=t,s=this.evaluateASTNode(i.left,e),n=this.evaluateASTNode(i.right,e);return i.operator==="AND"?s&&n:s||n}return!1}isConsecutiveTextNodes(t){return this.containsOnlyTextNodes(t.left)&&this.containsOnlyTextNodes(t.right)}containsOnlyTextNodes(t){if(t.type==="text")return!0;if(t.type==="operator"){let e=t;return e.operator==="AND"&&this.containsOnlyTextNodes(e.left)&&this.containsOnlyTextNodes(e.right)}return!1}extractConsecutiveText(t){if(t.type==="text")return t.value;if(t.type==="operator"){let e=t,i=this.extractConsecutiveText(e.left),s=this.extractConsecutiveText(e.right);return`${i} ${s}`}return""}highlightMatchesFilter(t,e){return e.filterType==="tag"?this.extractTagsFromHighlight(t).includes(e.value):e.filterType==="collection"?this.plugin.collectionsManager.getCollectionsForHighlight(t.id).map(n=>n.name).includes(e.value):!1}};var K=require("obsidian");var G=require("obsidian"),j=class extends G.AbstractInputSuggest{constructor(t,e){super(t,e);this.inputEl=e,this.folders=this.app.vault.getAllFolders(!0).map(i=>(0,G.normalizePath)(i.path)).filter(i=>i!==""),this.files=this.app.vault.getFiles().map(i=>(0,G.normalizePath)(i.path))}getSuggestions(t){let e=t.toLowerCase().trim();if(!e)return this.folders.slice(0,10);let i=this.folders.filter(n=>n.toLowerCase().includes(e)),s=this.files.filter(n=>n.toLowerCase().includes(e));return[...i,...s].slice(0,20)}renderSuggestion(t,e){e.setText(t)}selectSuggestion(t){this.inputEl.value=t;let e=new Event("input");this.inputEl.dispatchEvent(e),this.close()}};var Z=class extends K.Modal{constructor(t,e,i){super(t);this.excludedFiles=[...e],this.onUpdate=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("div",{cls:"modal-title",text:"Excluded files"}),this.renderStatusMessage(t),this.renderExcludedFilesList(t);let e=t.createDiv({cls:"setting-item"});e.createDiv({cls:"setting-item-info"}).createDiv({cls:"setting-item-name",text:"Filter"});let n=e.createDiv({cls:"setting-item-control"}).createDiv({cls:"excluded-files-input-container"});n.style.display="flex",n.style.gap="8px",this.filterInput=n.createEl("input",{type:"text",placeholder:"Enter file or folder path..."}),this.filterInput.style.flex="1",this.fileFolderSuggest=new j(this.app,this.filterInput),n.createEl("button",{text:"Add",cls:"mod-cta"}).addEventListener("click",()=>this.addFilter()),this.filterInput.addEventListener("keydown",l=>{l.key==="Enter"&&this.addFilter()}),this.renderModalButtons(t)}renderStatusMessage(t){let e=t.querySelector(".excluded-files-status");e&&e.remove();let i=t.createDiv({cls:"excluded-files-status"});i.style.marginTop="20px",this.excludedFiles.length===0?(i.setText("No excluded filter is applied right now. Add one below."),i.style.paddingBottom="20px"):(i.setText("Files matching the following filters are currently excluded:"),i.style.paddingBottom="10px")}renderExcludedFilesList(t){let e=t.querySelector(".excluded-files-list");if(e&&e.remove(),this.excludedFiles.length>0){let i=t.querySelector(".setting-item"),s=t.createDiv({cls:"excluded-files-list"});i&&t.insertBefore(s,i),this.excludedFiles.forEach(n=>{let a=s.createDiv({cls:"setting-item excluded-file-item"});a.createDiv({cls:"setting-item-info"}).createDiv({cls:"setting-item-name",text:n});let c=a.createDiv({cls:"setting-item-control"}).createEl("button",{cls:"clickable-icon"});(0,K.setIcon)(c,"x"),c.addEventListener("click",()=>{this.removeFilter(n)})})}}renderModalButtons(t){let e=t.createDiv({cls:"modal-button-container"});e.style.display="flex",e.style.justifyContent="flex-end",e.style.gap="8px",e.style.marginTop="20px",e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),e.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",()=>this.close())}addFilter(){let t=this.filterInput.value.trim();t&&!this.excludedFiles.includes(t)&&(this.excludedFiles.push(t),this.filterInput.value="",this.refreshContent(),this.onUpdate(this.excludedFiles))}removeFilter(t){this.excludedFiles=this.excludedFiles.filter(e=>e!==t),this.refreshContent(),this.onUpdate(this.excludedFiles)}refreshContent(){let t=this.contentEl.querySelector(".excluded-files-status");t&&(this.excludedFiles.length===0?(t.setText("No excluded filter is applied right now. Add one below."),t.style.paddingBottom="20px"):(t.setText("Files matching the following filters are currently excluded:"),t.style.paddingBottom="10px")),this.renderExcludedFilesList(this.contentEl)}onClose(){let{contentEl:t}=this;t.empty()}};var $={settingsVersion:"1.14.0",highlightColor:"#ffd700",sidebarPosition:"right",highlights:{},collections:{},groupingMode:"none",showFilenames:!0,showTimestamps:!0,showHighlightActions:!0,showToolbar:!0,autoToggleFold:!1,useInlineFootnotes:!1,selectTextOnCommentClick:!1,excludeExcalidraw:!0,excludedFiles:[],dateFormat:"YYYY-MM-DD HH:mm",minimumCharacterCount:0,highlightFontSize:11,detailsFontSize:11,commentFontSize:11,customColors:{yellow:"#ffd700",red:"#ff6b6b",teal:"#4ecdc4",blue:"#45b7d1",green:"#96ceb4"},customColorNames:{yellow:"",red:"",teal:"",blue:"",green:""}},J="highlights-sidebar",X=class extends E.Plugin{constructor(){super(...arguments);this.highlights=new Map;this.collections=new Map;this.sidebarView=null;this.detectHighlightsTimeout=null;this.selectedHighlightId=null;this.collectionCommands=new Set}async onload(){await this.loadSettings(),this.highlights=new Map(Object.entries(this.settings.highlights||{})),this.collections=new Map(Object.entries(this.settings.collections||{})),this.collectionsManager=new Q(this),this.inlineFootnoteManager=new B,"registerHoverLinkSource"in this.app.workspace&&this.app.workspace.registerHoverLinkSource("sidebar-highlights",{display:"Sidebar Highlights",defaultMod:!0}),this.registerView(J,t=>(this.sidebarView=new Y(t,this),this.sidebarView)),this.addRibbonIcon("highlighter","Open highlights",()=>{this.activateView()}),this.addCommand({id:"create-highlight",name:"Create highlight from selection",editorCallback:t=>{this.createHighlight(t)}}),this.addCommand({id:"open-highlights-sidebar",name:"Toggle",callback:()=>{this.toggleView()}}),this.registerEvent(this.app.workspace.on("editor-menu",(t,e,i)=>{e.getSelection()&&t.addItem(s=>{s.setTitle("Create highlight").setIcon("highlighter").onClick(()=>{this.createHighlight(e)})})})),this.registerEvent(this.app.workspace.on("file-open",t=>{t?this.loadHighlightsFromFile(t):(this.selectedHighlightId=null,this.sidebarView&&this.sidebarView.updateContent())})),this.registerEvent(this.app.workspace.on("editor-change",(t,e)=>{e instanceof E.MarkdownView&&this.debounceDetectMarkdownHighlights(t,e)})),this.addSettingTab(new nt(this.app,this)),this.addStyles(),this.registerCollectionCommands(),this.app.workspace.onLayoutReady(async()=>{await this.fixDuplicateTimestamps(),this.scanAllFilesForHighlights(),this.updateCustomColorStyles(),this.registerEvent(this.app.vault.on("create",t=>{t instanceof E.TFile&&this.shouldProcessFile(t)&&this.handleFileCreate(t)})),this.registerEvent(this.app.vault.on("rename",(t,e)=>{t instanceof E.TFile&&this.shouldProcessFile(t)&&this.handleFileRename(t,e)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof E.TFile&&this.shouldProcessFile(t)&&this.handleFileDelete(t)}))})}onunload(){}async loadSettings(){let t=await this.loadData();t&&t.settingsVersion&&t.settingsVersion!==$.settingsVersion?await this.migrateSettings(t):(this.settings=Object.assign({},$,t),this.settings.settingsVersion||(this.settings.settingsVersion=$.settingsVersion,await this.saveSettings()))}async saveSettings(){this.settings.highlights=Object.fromEntries(this.highlights),this.settings.collections=Object.fromEntries(this.collections),await this.saveData(this.settings),this.updateStyles()}addStyles(){let t=document.createElement("style");t.id="highlight-comments-plugin-styles",this.applyHighlightTheme(),this.updateCustomColorStyles(),document.head.appendChild(t)}updateStyles(){this.applyHighlightTheme(),this.updateCustomColorStyles()}removeStyles(){let t=document.getElementById("highlight-comments-plugin-styles");t&&t.remove();let e=document.getElementById("highlight-comments-custom-colors");e&&e.remove(),this.removeHighlightTheme()}applyHighlightTheme(){this.removeHighlightTheme();let t=this.getHighlightThemeClass(this.settings.highlightColor);document.body.classList.add(t)}removeHighlightTheme(){["theme-highlight-default","theme-highlight-yellow","theme-highlight-red","theme-highlight-teal","theme-highlight-blue","theme-highlight-green"].forEach(e=>{document.body.classList.remove(e)})}getHighlightThemeClass(t){return{[this.settings.customColors.yellow]:"theme-highlight-yellow",[this.settings.customColors.red]:"theme-highlight-red",[this.settings.customColors.teal]:"theme-highlight-teal",[this.settings.customColors.blue]:"theme-highlight-blue",[this.settings.customColors.green]:"theme-highlight-green"}[t]||"theme-highlight-default"}updateCustomColorStyles(){let t=document.getElementById("highlight-comments-custom-colors");t&&t.remove();let e=document.createElement("style");e.id="highlight-comments-custom-colors";let i=`
            /* Dynamic hover color options */
            .hover-color-option[data-color="${this.settings.customColors.yellow}"] { background-color: ${this.settings.customColors.yellow} !important; }
            .hover-color-option[data-color="${this.settings.customColors.red}"] { background-color: ${this.settings.customColors.red} !important; }
            .hover-color-option[data-color="${this.settings.customColors.teal}"] { background-color: ${this.settings.customColors.teal} !important; }
            .hover-color-option[data-color="${this.settings.customColors.blue}"] { background-color: ${this.settings.customColors.blue} !important; }
            .hover-color-option[data-color="${this.settings.customColors.green}"] { background-color: ${this.settings.customColors.green} !important; }
            
            /* Dynamic group color squares */
            .group-color-square[data-color="${this.settings.customColors.yellow}"] { background-color: ${this.settings.customColors.yellow} !important; }
            .group-color-square[data-color="${this.settings.customColors.red}"] { background-color: ${this.settings.customColors.red} !important; }
            .group-color-square[data-color="${this.settings.customColors.teal}"] { background-color: ${this.settings.customColors.teal} !important; }
            .group-color-square[data-color="${this.settings.customColors.blue}"] { background-color: ${this.settings.customColors.blue} !important; }
            .group-color-square[data-color="${this.settings.customColors.green}"] { background-color: ${this.settings.customColors.green} !important; }
            
            /* Dynamic highlight theme colors */
            body.theme-highlight-yellow .cm-highlight { background-color: ${this.settings.customColors.yellow}66 !important; }
            body.theme-highlight-red .cm-highlight { background-color: ${this.settings.customColors.red}66 !important; }
            body.theme-highlight-teal .cm-highlight { background-color: ${this.settings.customColors.teal}66 !important; }
            body.theme-highlight-blue .cm-highlight { background-color: ${this.settings.customColors.blue}66 !important; }
            body.theme-highlight-green .cm-highlight { background-color: ${this.settings.customColors.green}66 !important; }
            
            /* Dynamic highlight card border colors */
            .highlight-item-card.highlight-color-yellow { border-left-color: ${this.settings.customColors.yellow} !important; }
            .highlight-item-card.highlight-color-red { border-left-color: ${this.settings.customColors.red} !important; }
            .highlight-item-card.highlight-color-teal { border-left-color: ${this.settings.customColors.teal} !important; }
            .highlight-item-card.highlight-color-blue { border-left-color: ${this.settings.customColors.blue} !important; }
            .highlight-item-card.highlight-color-green { border-left-color: ${this.settings.customColors.green} !important; }
            
            /* Dynamic highlight card selection colors */
            .highlight-item-card.highlight-color-yellow.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.yellow}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-red.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.red}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-teal.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.teal}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-blue.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.blue}, var(--shadow-s) !important; }
            .highlight-item-card.highlight-color-green.highlight-selected { box-shadow: 0 0 0 1.5px ${this.settings.customColors.green}, var(--shadow-s) !important; }
            
            /* Dynamic font sizes */
            .highlight-quote { font-size: ${this.settings.highlightFontSize}px !important; }
            .highlight-actions, .highlight-filename, .highlight-stats-section, .highlight-timestamp-info, .comment-buttons, .highlight-info-line { font-size: ${this.settings.detailsFontSize}px !important; }
            .highlight-comment { font-size: ${this.settings.commentFontSize}px !important; }
        `;e.textContent=i,document.head.appendChild(e)}async activateView(){let{workspace:t}=this.app,e=null,i=t.getLeavesOfType(J);i.length>0?e=i[0]:(e=this.settings.sidebarPosition==="left"?t.getLeftLeaf(!1):t.getRightLeaf(!1),await(e==null?void 0:e.setViewState({type:J,active:!0}))),e&&t.revealLeaf(e)}async toggleView(){let{workspace:t}=this.app,e=t.getLeavesOfType(J);e.length>0?e.forEach(i=>i.detach()):await this.activateView()}async createHighlight(t){let e=t.getSelection();if(!e){new E.Notice("Please select some text first");return}let i=this.app.workspace.getActiveFile();if(!i){new E.Notice("No active file");return}let s=t.getCursor("from"),n=t.getCursor("to"),a=t.posToOffset(s),l=t.posToOffset(n),c={id:this.generateId(),text:e,tags:[],line:s.line,startOffset:a,endOffset:l,filePath:i.path,createdAt:Date.now()},h=this.highlights.get(i.path)||[];h.push(c),this.highlights.set(i.path,h);let g=`==${e}==`;t.replaceSelection(g),this.refreshSidebar(),new E.Notice("Highlight created")}refreshSidebar(){this.sidebarView&&this.sidebarView.refresh()}async reloadAllSettings(){await this.loadSettings(),this.collections=new Map(Object.entries(this.settings.collections||{})),this.highlights=new Map(Object.entries(this.settings.highlights||{})),this.registerCollectionCommands(),this.updateStyles(),this.refreshSidebar()}async createBackup(t){try{let e=new Date().toISOString().replace(/[:.]/g,"-"),i=`data-backup-${t}-${e}.json`,s={settingsVersion:this.settings.settingsVersion,collections:this.settings.collections,customColorNames:this.settings.customColorNames,highlights:this.settings.highlights,backupReason:t,originalTimestamp:e,backupCreatedAt:Date.now()},n=`.obsidian/plugins/sidebar-highlights/${i}`;await this.app.vault.adapter.write(n,JSON.stringify(s,null,2)),(t==="migration"||t==="manual")&&new E.Notice(`Settings backup created: ${i}`)}catch(e){console.error("Failed to create backup:",e),new E.Notice("Warning: Could not create settings backup")}}async migrateSettings(t){try{await this.createBackup("migration");let e=t.settingsVersion||"1.13.0",i=$.settingsVersion;e!==i&&new E.Notice(`Migrating settings from ${e} to ${i}...`);let s=t.collections||{},n=t.customColorNames||{},a=t.highlights||{};this.settings={...$},this.settings.collections=s,this.settings.customColorNames={...$.customColorNames,...n},this.settings.highlights=a,t.highlightColor!==void 0&&(this.settings.highlightColor=t.highlightColor),t.sidebarPosition!==void 0&&(this.settings.sidebarPosition=t.sidebarPosition),t.groupingMode!==void 0&&(this.settings.groupingMode=t.groupingMode),t.showFilenames!==void 0&&(this.settings.showFilenames=t.showFilenames),t.showTimestamps!==void 0&&(this.settings.showTimestamps=t.showTimestamps),t.showHighlightActions!==void 0&&(this.settings.showHighlightActions=t.showHighlightActions),t.showToolbar!==void 0&&(this.settings.showToolbar=t.showToolbar),t.useInlineFootnotes!==void 0&&(this.settings.useInlineFootnotes=t.useInlineFootnotes),t.selectTextOnCommentClick!==void 0&&(this.settings.selectTextOnCommentClick=t.selectTextOnCommentClick),t.excludeExcalidraw!==void 0&&(this.settings.excludeExcalidraw=t.excludeExcalidraw),t.excludedFiles!==void 0&&(this.settings.excludedFiles=t.excludedFiles),t.dateFormat!==void 0&&(this.settings.dateFormat=t.dateFormat),t.customColors!==void 0&&(this.settings.customColors={...$.customColors,...t.customColors}),this.settings.settingsVersion=i,this.collections=new Map(Object.entries(this.settings.collections||{})),this.highlights=new Map(Object.entries(this.settings.highlights||{})),await this.saveSettings(),e!==i&&(new E.Notice(`Settings successfully migrated to ${i}`),await this.validateCollectionReferences())}catch(e){console.error("Migration failed:",e),new E.Notice("Error during settings migration. Please check console for details.")}}async validateCollectionReferences(){try{let t=new Set;for(let s of this.highlights.values())s.forEach(n=>t.add(n.id));let e=0,i=[];for(let s of this.collections.values()){let n=s.highlightIds.filter(a=>!t.has(a));n.length>0&&(e+=n.length,i.push({name:s.name,brokenCount:n.length,totalCount:s.highlightIds.length}),s.highlightIds=s.highlightIds.filter(a=>t.has(a)))}if(e>0){let s=i.map(n=>`\u2022 ${n.name}: ${n.brokenCount}/${n.totalCount} references`).join(`
`);new E.Notice(`Migration complete, but ${e} highlight reference(s) couldn't be restored:

${s}

Broken references have been cleaned up. You may need to manually re-add some highlights to these collections.`,8e3),console.log("Collection validation results:",{totalBrokenReferences:e,collectionsWithIssues:i,message:"Some highlight references were lost during migration, likely due to file changes. Automatic cleanup completed."}),await this.saveSettings()}else new E.Notice("Migration successful! All collections and highlights preserved.",3e3)}catch(t){console.error("Collection validation failed:",t),new E.Notice("Warning: Could not validate collection references after migration.")}}async onExternalSettingsChange(){try{await this.createBackup("external-sync");let t=await this.loadData();t&&t.settingsVersion&&t.settingsVersion!==$.settingsVersion?await this.migrateSettings(t):await this.reloadAllSettings()}catch(t){console.error("Error handling external settings change:",t),await this.reloadAllSettings()}}registerCollectionCommands(){for(let t of this.collections.values()){let e=`go-to-collection-${t.id}`;this.addCommand({id:e,name:`Go to ${t.name}`,callback:()=>{this.goToCollection(t.id)}}),this.collectionCommands.add(e)}}unregisterCollectionCommands(){for(let t of this.collectionCommands)this.removeCommand(t);this.collectionCommands.clear()}async goToCollection(t){await this.activateView(),this.sidebarView&&this.sidebarView.navigateToCollection(t)}updateHighlight(t,e,i){let s=i,n;if(s)n=this.highlights.get(s);else for(let[l,o]of this.highlights)if(o.some(c=>c.id===t)){s=l,n=o;break}if(!s&&!i){let l=this.app.workspace.getActiveFile();l&&(s=l.path,n=this.highlights.get(s))}if(!s||!n)return;let a=n.findIndex(l=>l.id===t);if(a!==-1){let l={...n[a],...e},o=[...n];o[a]=l,this.highlights.set(s,o),this.saveSettings(),this.sidebarView&&this.sidebarView.updateItem(t)}}async loadHighlightsFromFile(t){if(this.selectedHighlightId?(this.highlights.get(t.path)||[]).find(n=>n.id===this.selectedHighlightId)||(this.selectedHighlightId=null):this.selectedHighlightId=null,!this.shouldProcessFile(t)){this.highlights.delete(t.path),this.sidebarView&&this.sidebarView.updateContent();return}if(await this.isExcalidrawFile(t)){this.highlights.delete(t.path),this.sidebarView&&this.sidebarView.updateContent();return}let e=await this.app.vault.read(t);this.detectAndStoreMarkdownHighlights(e,t),this.sidebarView&&this.sidebarView.updateContent()}debounceDetectMarkdownHighlights(t,e){this.detectHighlightsTimeout&&window.clearTimeout(this.detectHighlightsTimeout),this.detectHighlightsTimeout=window.setTimeout(()=>{this.detectMarkdownHighlights(t,e)},1e3)}async detectMarkdownHighlights(t,e){let i=e.file;if(!i)return;let s=t.getValue();this.detectAndStoreMarkdownHighlights(s,i)}async scanAllFilesForHighlights(){let e=this.app.vault.getMarkdownFiles().filter(n=>this.shouldProcessFile(n)),i=new Set(e.map(n=>n.path)),s=!1;for(let n of this.highlights.keys())i.has(n)||(this.highlights.delete(n),s=!0);for(let n of this.collections.values()){let a=n.highlightIds.length;n.highlightIds=n.highlightIds.filter(l=>{for(let[o,c]of this.highlights)if(c.some(h=>h.id===l))return!0;return!1}),n.highlightIds.length!==a&&(s=!0)}for(let n of e)try{if(await this.isExcalidrawFile(n)){this.highlights.has(n.path)&&(this.highlights.delete(n.path),s=!0);continue}let a=await this.app.vault.read(n),l=this.highlights.get(n.path)||[];this.detectAndStoreMarkdownHighlights(a,n,!1);let o=this.highlights.get(n.path)||[],c=JSON.stringify(l.map(g=>({id:g.id,text:g.text,start:g.startOffset,end:g.endOffset,footnotes:g.footnoteCount}))),h=JSON.stringify(o.map(g=>({id:g.id,text:g.text,start:g.startOffset,end:g.endOffset,footnotes:g.footnoteCount})));c!==h&&(s=!0)}catch(a){}s&&(await this.saveSettings(),this.refreshSidebar())}parseHtmlColor(t){let e=t.trim().toLowerCase(),i={yellow:"#ffff00",red:"#ff0000",green:"#008000",blue:"#0000ff",orange:"#ffa500",purple:"#800080",pink:"#ffc0cb",cyan:"#00ffff",magenta:"#ff00ff",lime:"#00ff00",brown:"#a52a2a",gray:"#808080",grey:"#808080",black:"#000000",white:"#ffffff"};return i[e]?i[e]:/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(e)?e.length===4?"#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]:e:null}getCssClassColor(t){try{let e=document.createElement("span");e.className=t,e.style.visibility="hidden",e.style.position="absolute",document.body.appendChild(e);let s=window.getComputedStyle(e).backgroundColor;return document.body.removeChild(e),this.rgbaToHex(s)}catch(e){return null}}rgbaToHex(t){if(!t||t==="transparent"||t==="rgba(0, 0, 0, 0)")return null;let e=t.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*([\d.]+))?\s*\)/);if(!e)return null;let i=parseInt(e[1],10),s=parseInt(e[2],10),n=parseInt(e[3],10),a=e[4]?parseFloat(e[4]):1,l=c=>c.toString(16).padStart(2,"0"),o=`#${l(i)}${l(s)}${l(n)}`;if(a<1){let c=Math.round(a*255).toString(16).padStart(2,"0");return o+c}return o}detectAndStoreMarkdownHighlights(t,e,i=!0){let s=/==([^=\n](?:[^=\n]|=[^=\n])*?[^=\n])==/g,n=/%%([^%](?:[^%]|%[^%])*?)%%/g,a=/<span\s+style=["'][^"']*background:\s*([^;"']+)[^"']*["'][^>]*>(.*?)<\/span>/gi,l=/<font\s+color=["']([^"']+)["'][^>]*>(.*?)<\/font>/gi,o=/<mark[^>]*>(.*?)<\/mark>/gi,c=/<span\s+class=["']([^"']+)["'][^>]*>(.*?)<\/span>/gi,h=[],g=this.highlights.get(e.path)||[],d=new Set,f=(m,w,S,b)=>{let y=g.find(M=>!d.has(M.id)&&M.text===m&&M.startOffset===w&&M.endOffset===S&&M.isNativeComment===b);if(y)return d.add(y.id),y;let k=g.find(M=>!d.has(M.id)&&M.text===m&&Math.abs(M.startOffset-w)<=50&&M.isNativeComment===b);if(k)return d.add(k.id),k;let N=g.find(M=>!d.has(M.id)&&M.text===m&&M.isNativeComment===b&&!g.some(F=>F!==M&&F.text===m&&F.isNativeComment===b));if(N)return d.add(N.id),N},u=this.extractFootnotes(t),p=this.getCodeBlockRanges(t),x=[],C;for(;(C=s.exec(t))!==null;)if(!this.isInsideCodeBlock(C.index,C.index+C[0].length,p)){let m=t.charAt(C.index-1),w=t.charAt(C.index+C[0].length);if(m==="="||w==="=")continue;x.push({match:C,type:"highlight"})}for(;(C=n.exec(t))!==null;)if(!this.isInsideCodeBlock(C.index,C.index+C[0].length,p)){let m=t.charAt(C.index-1),w=t.charAt(C.index+C[0].length);if(m==="%"||w==="%")continue;x.push({match:C,type:"comment"})}for(;(C=a.exec(t))!==null;)if(!this.isInsideCodeBlock(C.index,C.index+C[0].length,p)){let m=this.parseHtmlColor(C[1]);if(m){let w=Object.assign([],C);w[1]=C[2],x.push({match:w,type:"html",color:m})}}for(;(C=l.exec(t))!==null;)if(!this.isInsideCodeBlock(C.index,C.index+C[0].length,p)){let m=this.parseHtmlColor(C[1]);if(m){let w=Object.assign([],C);w[1]=C[2],x.push({match:w,type:"html",color:m})}}for(;(C=o.exec(t))!==null;)if(!this.isInsideCodeBlock(C.index,C.index+C[0].length,p)){let m=Object.assign([],C);m[1]=C[1],x.push({match:m,type:"html",color:"#ffff00"})}for(;(C=c.exec(t))!==null;)if(!this.isInsideCodeBlock(C.index,C.index+C[0].length,p)){let m=C[1].trim(),w=this.getCssClassColor(m);if(w){let S=Object.assign([],C);S[1]=C[2],x.push({match:S,type:"html",color:w})}}x.sort((m,w)=>m.match.index-w.match.index),x.forEach(({match:m,type:w,color:S})=>{let[,b]=m;if(!b||b.trim()==="")return;let y=f(b,m.index,m.index+m[0].length,w==="comment"),k=t.substring(0,m.index).split(`
`).length-1,N=[],M=0;if(w==="highlight"||w==="html"){let F=t.substring(m.index+m[0].length),O=[];this.inlineFootnoteManager.extractInlineFootnotes(t,m.index+m[0].length).forEach(L=>{L.content.trim()&&O.push({type:"inline",index:L.startIndex,content:L.content.trim()})});let rt=/(\s*\[\^(\w+)\])(?!:)/g,R,et=0;for(;(R=rt.exec(F))!==null;){let L=F.substring(et,R.index),it=/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/.test(L);if(R.index===et||it){let ot=R[2];if(u.has(ot)){let lt=u.get(ot).trim();lt&&O.push({type:"standard",index:m.index+m[0].length+R.index,content:lt})}et=R.index+R[0].length}else break}O.sort((L,it)=>L.index-it.index),N=O.map(L=>L.content),M=N.length}else w==="comment"&&(N=[b],M=1);if(y)h.push({...y,line:k,startOffset:m.index,endOffset:m.index+m[0].length,filePath:e.path,footnoteCount:M,footnoteContents:N,isNativeComment:w==="comment",color:w==="html"?S:y.color,createdAt:y.createdAt||Date.now(),type:w});else{let F=e.stat.mtime+m.index%1e3;h.push({id:this.generateId(),text:b,tags:[],line:k,startOffset:m.index,endOffset:m.index+m[0].length,filePath:e.path,footnoteCount:M,footnoteContents:N,createdAt:F,isNativeComment:w==="comment",color:w==="html"?S:void 0,type:w})}});let H=JSON.stringify(g.map(m=>{var w;return{id:m.id,start:m.startOffset,end:m.endOffset,text:m.text,footnotes:m.footnoteCount,contents:(w=m.footnoteContents)==null?void 0:w.filter(S=>S.trim()!==""),color:m.color,isNativeComment:m.isNativeComment}})),T=JSON.stringify(h.map(m=>{var w;return{id:m.id,start:m.startOffset,end:m.endOffset,text:m.text,footnotes:m.footnoteCount,contents:(w=m.footnoteContents)==null?void 0:w.filter(S=>S.trim()!==""),color:m.color,isNativeComment:m.isNativeComment}}));H!==T&&(this.highlights.set(e.path,h),i&&(this.saveSettings(),this.smartUpdateSidebar(g,h)))}smartUpdateSidebar(t,e){var o,c;if(!this.sidebarView)return;let i=new Map,s=new Map;t.forEach(h=>i.set(h.id,h)),e.forEach(h=>s.set(h.id,h));let n=new Set(i.keys()),a=new Set(s.keys());if(n.size!==a.size||[...n].some(h=>!a.has(h))||[...a].some(h=>!n.has(h)))this.refreshSidebar();else for(let[h,g]of s){let d=i.get(h);if(d){let f=JSON.stringify({text:d.text,footnotes:d.footnoteCount,contents:(o=d.footnoteContents)==null?void 0:o.filter(p=>p.trim()!==""),color:d.color,isNativeComment:d.isNativeComment}),u=JSON.stringify({text:g.text,footnotes:g.footnoteCount,contents:(c=g.footnoteContents)==null?void 0:c.filter(p=>p.trim()!==""),color:g.color,isNativeComment:g.isNativeComment});f!==u&&this.sidebarView.updateItem(h)}}}extractFootnotes(t){let e=new Map,i=/^\[\^(\w+)\]:\s*(.+)$/gm,s;for(;(s=i.exec(t))!==null;){let[,n,a]=s;e.set(n,a.trim())}return e}async handleFileCreate(t){try{let e=await this.app.vault.read(t);this.detectAndStoreMarkdownHighlights(e,t,!1);let i=this.highlights.get(t.path);i&&i.length>0&&(await this.saveSettings(),this.refreshSidebar())}catch(e){}}async handleFileRename(t,e){let i=this.highlights.get(e);if(i&&i.length>0){let s=i.map(n=>({...n,filePath:t.path}));this.highlights.delete(e),this.highlights.set(t.path,s),await this.saveSettings(),this.refreshSidebar()}}handleFileDelete(t){if(this.highlights.has(t.path)){let e=new Set((this.highlights.get(t.path)||[]).map(s=>s.id));this.highlights.delete(t.path);let i=!1;for(let s of this.collections.values()){let n=s.highlightIds.length;s.highlightIds=s.highlightIds.filter(a=>!e.has(a)),s.highlightIds.length!==n&&(i=!0)}this.saveSettings(),this.refreshSidebar()}}getCurrentFileHighlights(){let t=this.app.workspace.getActiveFile();return t?this.highlights.get(t.path)||[]:[]}generateId(){return Math.random().toString(36).substr(2,9)}shouldProcessFile(t){return!(t.extension!=="md"||this.settings.excludeExcalidraw&&t.name.endsWith(".excalidraw.md")||this.isFileExcluded(t.path))}isFileExcluded(t){if(!this.settings.excludedFiles||this.settings.excludedFiles.length===0)return!1;let e=t.replace(/\\/g,"/");for(let i of this.settings.excludedFiles){let s=i.replace(/\\/g,"/");if(e===s||e.startsWith(s+"/"))return!0}return!1}async isExcalidrawFile(t){if(!this.settings.excludeExcalidraw)return!1;if(t.name.endsWith(".excalidraw.md"))return!0;try{let i=(await this.app.vault.read(t)).match(/^---\n([\s\S]*?)\n---/);if(i){let s=i[1];if(/excalidraw-plugin:\s*parsed/i.test(s)||/tags:\s*\[.*excalidraw.*\]/i.test(s))return!0}}catch(e){}return!1}async fixDuplicateTimestamps(){let t=!1;for(let[e,i]of this.highlights){let s=new Map;i.forEach(n=>{n.createdAt&&(s.has(n.createdAt)||s.set(n.createdAt,[]),s.get(n.createdAt).push(n))});for(let[n,a]of s)a.length>1&&(a.sort((l,o)=>l.startOffset-o.startOffset),a.forEach((l,o)=>{o>0&&(l.createdAt=n+o,t=!0)}))}t&&(await this.saveSettings(),this.refreshSidebar())}getCodeBlockRanges(t){let e=[],i=/^```[\s\S]*?\n```\s*$/gm,s=/^~~~[\s\S]*?\n~~~\s*$/gm,n;for(;(n=i.exec(t))!==null;)e.push({start:n.index,end:n.index+n[0].length});for(;(n=s.exec(t))!==null;)e.push({start:n.index,end:n.index+n[0].length});let a=/`([^`\n]+?)`/g;for(;(n=a.exec(t))!==null;)e.push({start:n.index,end:n.index+n[0].length});return e}isInsideCodeBlock(t,e,i){return i.some(s=>t>=s.start&&e<=s.end)}},nt=class extends E.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new E.Setting(t).setHeading().setName("Display"),new E.Setting(t).setName("Show note titles in all notes and collections").setDesc("Display the filename/note title below highlights when viewing All Notes or Collections.").addToggle(l=>l.setValue(this.plugin.settings.showFilenames).onChange(async o=>{this.plugin.settings.showFilenames=o,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Show note timestamps").setDesc("Display creation timestamps for highlights.").addToggle(l=>l.setValue(this.plugin.settings.showTimestamps).onChange(async o=>{this.plugin.settings.showTimestamps=o,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Show highlight actions").setDesc("Display the actions area below each highlight (filename, stats, and buttons).").addToggle(l=>l.setValue(this.plugin.settings.showHighlightActions).onChange(async o=>{this.plugin.settings.showHighlightActions=o,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Show toolbar").setDesc("Display the toolbar with search, grouping, and other action buttons.").addToggle(l=>l.setValue(this.plugin.settings.showToolbar).onChange(async o=>{this.plugin.settings.showToolbar=o,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Auto-unfold on focus").setDesc("Automatically unfold content when focusing highlights from the sidebar.").addToggle(l=>l.setValue(this.plugin.settings.autoToggleFold).onChange(async o=>{this.plugin.settings.autoToggleFold=o,await this.plugin.saveSettings()})),new E.Setting(t).setName("Date format").setDesc("Format string for timestamps using moment.js syntax (e.g., YYYY-MM-DD HH:mm, MMM DD YYYY, DD/MM/YYYY h:mm A).").addMomentFormat(l=>l.setValue(this.plugin.settings.dateFormat).setPlaceholder("YYYY-MM-DD HH:mm").onChange(async o=>{this.plugin.settings.dateFormat=o,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setName("Minimum character count").setDesc("Hide highlights and native comments shorter than this character count from the sidebar (default 0).").addText(l=>l.setPlaceholder("0").setValue(this.plugin.settings.minimumCharacterCount.toString()).onChange(async o=>{let c=parseInt(o)||0;this.plugin.settings.minimumCharacterCount=Math.max(0,c),await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setHeading().setName("Typography"),new E.Setting(t).setName("Main highlight text").setDesc("Adjust main highlight text size (default 11).").addText(l=>l.setPlaceholder("11").setValue(this.plugin.settings.highlightFontSize.toString()).onChange(async o=>{let c=parseInt(o);!isNaN(c)&&c>=8&&c<=32&&(this.plugin.settings.highlightFontSize=c,await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar())})),new E.Setting(t).setName("Details text size").setDesc("Adjust details text size (filename, line number, etc) (default 11).").addText(l=>l.setPlaceholder("11").setValue(this.plugin.settings.detailsFontSize.toString()).onChange(async o=>{let c=parseInt(o);!isNaN(c)&&c>=8&&c<=24&&(this.plugin.settings.detailsFontSize=c,await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar())})),new E.Setting(t).setName("Comment text size").setDesc("Adjust comment text size (default 11).").addText(l=>l.setPlaceholder("11").setValue(this.plugin.settings.commentFontSize.toString()).onChange(async o=>{let c=parseInt(o);!isNaN(c)&&c>=8&&c<=24&&(this.plugin.settings.commentFontSize=c,await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar())})),new E.Setting(t).setHeading().setName("Styling");let e=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.yellow.toUpperCase()}`).setDesc("Customize the first highlight color.").addColorPicker(l=>l.setValue(this.plugin.settings.customColors.yellow).onChange(async o=>{this.plugin.settings.customColors.yellow=o,await this.plugin.saveSettings(),this.updateColorMappings(),e.setName(`Highlight color: ${o.toUpperCase()}`)})).addButton(l=>l.setButtonText("Reset").setTooltip("Reset to default yellow (#ffd700)").onClick(async()=>{this.plugin.settings.customColors.yellow="#ffd700",await this.plugin.saveSettings(),this.updateColorMappings(),e.setName(`Highlight color: ${this.plugin.settings.customColors.yellow.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(l=>l.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.yellow).onChange(async o=>{this.plugin.settings.customColorNames.yellow=o,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let i=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.red.toUpperCase()}`).setDesc("Customize the second highlight color.").addColorPicker(l=>l.setValue(this.plugin.settings.customColors.red).onChange(async o=>{this.plugin.settings.customColors.red=o,await this.plugin.saveSettings(),this.updateColorMappings(),i.setName(`Highlight color: ${o.toUpperCase()}`)})).addButton(l=>l.setButtonText("Reset").setTooltip("Reset to default red (#ff6b6b)").onClick(async()=>{this.plugin.settings.customColors.red="#ff6b6b",await this.plugin.saveSettings(),this.updateColorMappings(),i.setName(`Highlight color: ${this.plugin.settings.customColors.red.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(l=>l.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.red).onChange(async o=>{this.plugin.settings.customColorNames.red=o,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let s=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.teal.toUpperCase()}`).setDesc("Customize the third highlight color.").addColorPicker(l=>l.setValue(this.plugin.settings.customColors.teal).onChange(async o=>{this.plugin.settings.customColors.teal=o,await this.plugin.saveSettings(),this.updateColorMappings(),s.setName(`Highlight color: ${o.toUpperCase()}`)})).addButton(l=>l.setButtonText("Reset").setTooltip("Reset to default teal (#4ecdc4)").onClick(async()=>{this.plugin.settings.customColors.teal="#4ecdc4",await this.plugin.saveSettings(),this.updateColorMappings(),s.setName(`Highlight color: ${this.plugin.settings.customColors.teal.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(l=>l.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.teal).onChange(async o=>{this.plugin.settings.customColorNames.teal=o,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let n=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.blue.toUpperCase()}`).setDesc("Customize the fourth highlight color.").addColorPicker(l=>l.setValue(this.plugin.settings.customColors.blue).onChange(async o=>{this.plugin.settings.customColors.blue=o,await this.plugin.saveSettings(),this.updateColorMappings(),n.setName(`Highlight color: ${o.toUpperCase()}`)})).addButton(l=>l.setButtonText("Reset").setTooltip("Reset to default blue (#45b7d1)").onClick(async()=>{this.plugin.settings.customColors.blue="#45b7d1",await this.plugin.saveSettings(),this.updateColorMappings(),n.setName(`Highlight color: ${this.plugin.settings.customColors.blue.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(l=>l.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.blue).onChange(async o=>{this.plugin.settings.customColorNames.blue=o,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let a=new E.Setting(t).setName(`Highlight color: ${this.plugin.settings.customColors.green.toUpperCase()}`).setDesc("Customize the fifth highlight color.").addColorPicker(l=>l.setValue(this.plugin.settings.customColors.green).onChange(async o=>{this.plugin.settings.customColors.green=o,await this.plugin.saveSettings(),this.updateColorMappings(),a.setName(`Highlight color: ${o.toUpperCase()}`)})).addButton(l=>l.setButtonText("Reset").setTooltip("Reset to default green (#96ceb4)").onClick(async()=>{this.plugin.settings.customColors.green="#96ceb4",await this.plugin.saveSettings(),this.updateColorMappings(),a.setName(`Highlight color: ${this.plugin.settings.customColors.green.toUpperCase()}`),this.display()}));new E.Setting(t).setName("Highlight name").setDesc("Optional: Add a custom name for this color to use in Group By Color instead of the hex code.").addText(l=>l.setPlaceholder('e.g., "Important", "Research"').setValue(this.plugin.settings.customColorNames.green).onChange(async o=>{this.plugin.settings.customColorNames.green=o,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new E.Setting(t).setHeading().setName("Comments"),new E.Setting(t).setName("Use inline footnotes by default").setDesc("When adding comments via the sidebar, use inline footnotes (^[comment]) instead of standard footnotes ([^ref]: comment).").addToggle(l=>l.setValue(this.plugin.settings.useInlineFootnotes).onChange(async o=>{this.plugin.settings.useInlineFootnotes=o,await this.plugin.saveSettings()})),new E.Setting(t).setName("Select text on click").setDesc("When clicking a comment, select the comment instead of positioning the cursor in front of it.").addToggle(l=>l.setValue(this.plugin.settings.selectTextOnCommentClick).onChange(async o=>{this.plugin.settings.selectTextOnCommentClick=o,await this.plugin.saveSettings()})),new E.Setting(t).setHeading().setName("Filters"),new E.Setting(t).setName("Exclude Excalidraw files").setDesc("Skip .excalidraw files when scanning for highlights. This prevents highlights from being detected in Excalidraw drawing files.").addToggle(l=>l.setValue(this.plugin.settings.excludeExcalidraw).onChange(async o=>{this.plugin.settings.excludeExcalidraw=o,await this.plugin.saveSettings(),this.plugin.scanAllFilesForHighlights()})),new E.Setting(t).setName("Excluded files").setDesc("Excluded files or folders will be hidden from Sidebar Highlights.").addButton(l=>{l.setButtonText("Manage").onClick(()=>{new Z(this.app,this.plugin.settings.excludedFiles,async c=>{this.plugin.settings.excludedFiles=c,await this.plugin.saveSettings(),this.plugin.scanAllFilesForHighlights()}).open()})})}updateColorMappings(){this.plugin.refreshSidebar(),this.plugin.updateStyles()}},Q=class{constructor(r){this.plugin=r}createCollection(r,t){let e={id:this.plugin.generateId(),name:r,description:t,highlightIds:[],createdAt:Date.now()};return this.plugin.collections.set(e.id,e),this.plugin.saveSettings(),this.plugin.registerCollectionCommands(),e}deleteCollection(r){let t=`go-to-collection-${r}`;this.plugin.collectionCommands.has(t)&&(this.plugin.removeCommand(t),this.plugin.collectionCommands.delete(t)),this.plugin.collections.delete(r),this.plugin.saveSettings()}async deleteCollectionWithConfirmation(r){let t=this.plugin.collections.get(r);return t&&confirm(`Are you sure you want to delete "${t.name}"?`)?(this.deleteCollection(r),!0):!1}addHighlightToCollection(r,t){let e=this.plugin.collections.get(r);e&&!e.highlightIds.includes(t)&&(e.highlightIds.push(t),this.plugin.saveSettings())}removeHighlightFromCollection(r,t){let e=this.plugin.collections.get(r);e&&(e.highlightIds=e.highlightIds.filter(i=>i!==t),this.plugin.saveSettings())}getAllCollections(){return Array.from(this.plugin.collections.values())}getCollection(r){return this.plugin.collections.get(r)}getCollectionStats(r){let t=this.plugin.collections.get(r);if(!t)return{highlightCount:0,fileCount:0,nativeCommentsCount:0};let e=new Set,i=0,s=0;for(let n of t.highlightIds)for(let[a,l]of this.plugin.highlights){let o=l.find(c=>c.id===n);if(o){e.add(a),o.isNativeComment?s++:i++;break}}return{highlightCount:i,fileCount:e.size,nativeCommentsCount:s}}getHighlightsInCollection(r){let t=this.plugin.collections.get(r);if(!t)return[];let e=[];for(let i of t.highlightIds)for(let[s,n]of this.plugin.highlights){let a=n.find(l=>l.id===i);if(a){e.push(a);break}}return e}getHighlightCollectionCount(r){let t=0;for(let e of this.plugin.collections.values())e.highlightIds.includes(r)&&t++;return t}getCollectionsForHighlight(r){let t=[];for(let e of this.plugin.collections.values())e.highlightIds.includes(r)&&t.push(e);return t}};

/* nosourcemap */